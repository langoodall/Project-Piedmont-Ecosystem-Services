---
title: "Untitled"
output: pdf_document
date: "2024-12-18"
---

```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(terra)
library(sf)
library(corrplot)
# library(vegan)
library(data.table)
options(scipen = 999)
templateRaster <- rast("D:/Landis Outputs/Raster Template/templateRaster.tif")
softwoods <- c("JUVI","PIEC2","PIPA2","PIST","PITA","PIVI2","TAAS","TADI2")
oaks <- c("QUAL","QUCO2","QUFA","QULA3","QUNI","QUPH","QUPR2","QURU","QUST","QUVE")
hardwoods <- c("ACRU","CAAL27","CAGL8","FAGR","FRAM2","FRPE","LIST2","LITU","NYBI","NYSY","OXAR","PRSE2")
```


# RESISTANCE
## RCP45
### HSHV (BNU-ESM)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP45/HSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_BNU_ESM_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "BNU-ESM_RCP45",
         Prescription = "Resistance")

# Proportional composition
propBiomass_BNU_ESM_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "BNU-ESM_RCP45",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_BNU_ESM_RCP45_Resistance_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP45",
         Model = "BNU-ESM_RCP45",
         Prescription = "Resistance")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_BNU_ESM_RCP45_Resistance <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP45", Model = "BNU-ESM_RCP45") %>%
  mutate(Prescription = "Resistance")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
BNU_ESM_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "BNU-ESM_RCP45")

#----BIODIVERSITY----#
diversity_BNU_ESM_RCP45_Resistance <- propBiomass_BNU_ESM_RCP45_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_BNU_ESM_RCP45_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

successionLog_BNU_ESM_RCP45_Resistance_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "BNU-ESM_RCP45", RCP = "RCP45", Prescription = "Resistance")
  results[[i]] <- df
}
AWB_BNU_ESM_RCP45_ResistanceDf <- bind_rows(results)


#----STRUCTURAL DIVERSITY----#
# ATTENTION
# This section require lots of RAM and has to cycle through a lot of rows in the dataframe.
# Because of that all Structural Diversity sections will need to be exported to the HPC
# for this piece of the analysis
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")

```

### HSLV (MIROC-ESM-CHEM)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP45/HSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_MIROC_ESM_CHEM_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "MIROC-ESM-CHEM_RCP45",
         Prescription = "Resistance")

# Proportional composition
propBiomass_MIROC_ESM_CHEM_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "MIROC-ESM-CHEM_RCP45",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_MIROC_ESM_CHEM_RCP45_Resistance_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP45",
         Model = "MIROC-ESM-CHEM_RCP45",
         Prescription = "Resistance")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_MIROC_ESM_CHEM_RCP45_Resistance <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP45", Model = "MIROC-ESM-CHEM_RCP45") %>%
  mutate(Prescription = "Resistance")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45")

#----BIODIVERSITY----#
diversity_MIROC_ESM_CHEM_RCP45_Resistance <- propBiomass_MIROC_ESM_CHEM_RCP45_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_MIROC_ESM_CHEM_RCP45_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

successionLog_MIROC_ESM_CHEM_RCP45_Resistance_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "MIROC-ESM-CHEM_RCP45", RCP = "RCP45", Prescription = "Resistance")
  results[[i]] <- df
}
AWB_MIROC_ESM_CHEM_RCP45_ResistanceDf <- bind_rows(results)

# #----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")

```

### LSHV (MRI-CGCM3)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP45/LSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_MRI_CGCM3_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "MRI-CGCM3_RCP45",
         Prescription = "Resistance")

# Proportional composition
propBiomass_MRI_CGCM3_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "MRI-CGCM3_RCP45",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_MRI_CGCM3_RCP45_Resistance_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP45",
         Model = "MRI-CGCM3_RCP45",
         Prescription = "Resistance")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_MRI_CGCM3_RCP45_Resistance <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP45", Model = "MRI-CGCM3_RCP45") %>%
  mutate(Prescription = "Resistance")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MRI_CGCM3_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MRI-CGCM3_RCP45")

#----BIODIVERSITY----#
diversity_MRI_CGCM3_RCP45_Resistance <- propBiomass_MRI_CGCM3_RCP45_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_MRI_CGCM3_RCP45_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

successionLog_MRI_CGCM3_RCP45_Resistance_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "MRI-CGCM3_RCP45", RCP = "RCP45", Prescription = "Resistance")
  results[[i]] <- df
}
AWB_MRI_CGCM3_RCP45_ResistanceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### LSLV (CCSM4)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP45/LSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_CCSM4_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "CCSM4_RCP45",
         Prescription = "Resistance")

# Proportional composition
propBiomass_CCSM4_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "CCSM4_RCP45",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_CCSM4_RCP45_Resistance_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP45",
         Model = "CCSM4_RCP45",
         Prescription = "Resistance")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_CCSM4_RCP45_Resistance <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP45", Model = "CCSM4_RCP45") %>%
  mutate(Prescription = "Resistance")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
CCSM4_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "CCSM4_RCP45")

#----BIODIVERSITY----#
diversity_CCSM4_RCP45_Resistance <- propBiomass_CCSM4_RCP45_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_CCSM4_RCP45_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

successionLog_CCSM4_RCP45_Resistance_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "CCSM4_RCP45", RCP = "RCP45", Prescription = "Resistance")
  results[[i]] <- df
}
AWB_CCSM4_RCP45_ResistanceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")

```

## RCP85
### HSHV (BNU-ESM)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP85/HSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_BNU_ESM_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Resistance")

# Proportional composition
propBiomass_BNU_ESM_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_BNU_ESM_RCP85_Resistance_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Resistance")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_BNU_ESM_RCP85_Resistance <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP85", Model = "BNU-ESM_RCP85") %>%
  mutate(Prescription = "Resistance")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
BNU_ESM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "BNU-ESM_RCP85")

#----BIODIVERSITY----#
diversity_BNU_ESM_RCP85_Resistance <- propBiomass_BNU_ESM_RCP85_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_BNU_ESM_RCP85_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

successionLog_BNU_ESM_RCP85_Resistance_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "BNU-ESM_RCP85", RCP = "RCP85", Prescription = "Resistance")
  results[[i]] <- df
}
AWB_BNU_ESM_RCP85_ResistanceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### HSLV (MIROC-ESM-CHEM)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP85/HSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_MIROC_ESM_CHEM_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Resistance")

# Proportional composition
propBiomass_MIROC_ESM_CHEM_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_MIROC_ESM_CHEM_RCP85_Resistance_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Resistance")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_MIROC_ESM_CHEM_RCP85_Resistance <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP85", Model = "MIROC-ESM-CHEM_RCP85") %>%
  mutate(Prescription = "Resistance")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85")

#----BIODIVERSITY----#
diversity_MIROC_ESM_CHEM_RCP85_Resistance <- propBiomass_MIROC_ESM_CHEM_RCP85_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_MIROC_ESM_CHEM_RCP85_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

successionLog_MIROC_ESM_CHEM_RCP85_Resistance_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "MIROC-ESM-CHEM_RCP85", RCP = "RCP85", Prescription = "Resistance")
  results[[i]] <- df
}
AWB_MIROC_ESM_CHEM_RCP85_ResistanceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### LSHV (MRI-CGCM3)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP85/LSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_MRI_CGCM3_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Resistance")

# Proportional composition
propBiomass_MRI_CGCM3_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_MRI_CGCM3_RCP85_Resistance_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Resistance")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_MRI_CGCM3_RCP85_Resistance <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP85", Model = "MRI-CGCM3_RCP85") %>%
  mutate(Prescription = "Resistance")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MRI_CGCM3_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MRI-CGCM3_RCP85")

#----BIODIVERSITY----#
diversity_MRI_CGCM3_RCP85_Resistance <- propBiomass_MRI_CGCM3_RCP85_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_MRI_CGCM3_RCP85_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

successionLog_MRI_CGCM3_RCP85_Resistance_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "MRI-CGCM3_RCP85", RCP = "RCP85", Prescription = "Resistance")
  results[[i]] <- df
}
AWB_MRI_CGCM3_RCP85_ResistanceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### LSLV (CCSM4)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP85/LSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_CCSM4_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Resistance")

# Proportional composition
propBiomass_CCSM4_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_CCSM4_RCP85_Resistance_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Resistance")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_CCSM4_RCP85_Resistance <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP85", Model = "CCSM4_RCP85") %>%
  mutate(Prescription = "Resistance")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
CCSM4_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "CCSM4_RCP85")

#----BIODIVERSITY----#
diversity_CCSM4_RCP85_Resistance <- propBiomass_CCSM4_RCP85_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_CCSM4_RCP85_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

successionLog_CCSM4_RCP85_Resistance_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "CCSM4_RCP85", RCP = "RCP85", Prescription = "Resistance")
  results[[i]] <- df
}
AWB_CCSM4_RCP85_ResistanceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

# RESILIENCE
## RCP45
### HSHV (BNU-ESM)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resilience/RCP45/HSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_BNU_ESM_RCP45_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "BNU-ESM_RCP45",
         Prescription = "Resilience")

# Proportional composition
propBiomass_BNU_ESM_RCP45_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "BNU-ESM_RCP45",
         Prescription = "Resilience",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_BNU_ESM_RCP45_Resilience_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP45",
         Model = "BNU-ESM_RCP45",
         Prescription = "Resilience")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_BNU_ESM_RCP45_Resilience <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP45", Model = "BNU-ESM_RCP45") %>%
  mutate(Prescription = "Resilience")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
BNU_ESM_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "BNU-ESM_RCP45")

#----BIODIVERSITY----#
diversity_BNU_ESM_RCP45_Resilience <- propBiomass_BNU_ESM_RCP45_Resilience[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Resilience")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_BNU_ESM_RCP45_Resilience <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Resilience")

successionLog_BNU_ESM_RCP45_Resilience_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Resilience")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "BNU-ESM_RCP45", RCP = "RCP45", Prescription = "Resilience")
  results[[i]] <- df
}
AWB_BNU_ESM_RCP45_ResilienceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### HSLV (MIROC-ESM-CHEM)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resilience/RCP45/HSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_MIROC_ESM_CHEM_RCP45_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "MIROC-ESM-CHEM_RCP45",
         Prescription = "Resilience")

# Proportional composition
propBiomass_MIROC_ESM_CHEM_RCP45_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "MIROC-ESM-CHEM_RCP45",
         Prescription = "Resilience",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_MIROC_ESM_CHEM_RCP45_Resilience_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP45",
         Model = "MIROC-ESM-CHEM_RCP45",
         Prescription = "Resilience")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_MIROC_ESM_CHEM_RCP45_Resilience <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP45", Model = "MIROC-ESM-CHEM_RCP45") %>%
  mutate(Prescription = "Resilience")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45")

#----BIODIVERSITY----#
diversity_MIROC_ESM_CHEM_RCP45_Resilience <- propBiomass_MIROC_ESM_CHEM_RCP45_Resilience[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Resilience")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_MIROC_ESM_CHEM_RCP45_Resilience <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Resilience")

successionLog_MIROC_ESM_CHEM_RCP45_Resilience_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Resilience")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "MIROC-ESM-CHEM_RCP45", RCP = "RCP45", Prescription = "Resilience")
  results[[i]] <- df
}
AWB_MIROC_ESM_CHEM_RCP45_ResilienceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")

```

### LSHV (MRI-CGCM3)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resilience/RCP45/LSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_MRI_CGCM3_RCP45_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "MRI-CGCM3_RCP45",
         Prescription = "Resilience")

# Proportional composition
propBiomass_MRI_CGCM3_RCP45_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "MRI-CGCM3_RCP45",
         Prescription = "Resilience",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_MRI_CGCM3_RCP45_Resilience_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP45",
         Model = "MRI-CGCM3_RCP45",
         Prescription = "Resilience")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_MRI_CGCM3_RCP45_Resilience <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP45", Model = "MRI-CGCM3_RCP45") %>%
  mutate(Prescription = "Resilience")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MRI-CGCM3_RCP45")

#----BIODIVERSITY----#
diversity_MRI_CGCM3_RCP45_Resilience <- propBiomass_MRI_CGCM3_RCP45_Resilience[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Resilience")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_MRI_CGCM3_RCP45_Resilience <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Resilience")

successionLog_MRI_CGCM3_RCP45_Resilience_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Resilience")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "MRI-CGCM3_RCP45", RCP = "RCP45", Prescription = "Resilience")
  results[[i]] <- df
}
AWB_MRI_CGCM3_RCP45_ResilienceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### LSLV (CCSM4)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resilience/RCP45/LSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_CCSM4_RCP45_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "CCSM4_RCP45",
         Prescription = "Resilience")

# Proportional composition
propBiomass_CCSM4_RCP45_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "CCSM4_RCP45",
         Prescription = "Resilience",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_CCSM4_RCP45_Resilience_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP45",
         Model = "CCSM4_RCP45",
         Prescription = "Resilience")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_CCSM4_RCP45_Resilience <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP45", Model = "CCSM4_RCP45") %>%
  mutate(Prescription = "Resilience")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "CCSM4_RCP45")

#----BIODIVERSITY----#
diversity_CCSM4_RCP45_Resilience <- propBiomass_CCSM4_RCP45_Resilience[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Resilience")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_CCSM4_RCP45_Resilience <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Resilience")

successionLog_CCSM4_RCP45_Resilience_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Resilience")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "CCSM4_RCP45", RCP = "RCP45", Prescription = "Resilience")
  results[[i]] <- df
}
AWB_CCSM4_RCP45_ResilienceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

## RCP85
### HSHV (BNU-ESM)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resilience/RCP85/HSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_BNU_ESM_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Resilience")

# Proportional composition
propBiomass_BNU_ESM_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Resilience",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_BNU_ESM_RCP85_Resilience_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Resilience")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_BNU_ESM_RCP85_Resilience <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP85", Model = "BNU-ESM_RCP85") %>%
  mutate(Prescription = "Resilience")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
BNU_ESM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "BNU-ESM_RCP85")

#----BIODIVERSITY----#
diversity_BNU_ESM_RCP85_Resilience <- propBiomass_BNU_ESM_RCP85_Resilience[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_BNU_ESM_RCP85_Resilience <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

successionLog_BNU_ESM_RCP85_Resilience_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "BNU-ESM_RCP85", RCP = "RCP85", Prescription = "Resilience")
  results[[i]] <- df
}
AWB_BNU_ESM_RCP85_ResilienceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### HSLV (MIROC-ESM-CHEM)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resilience/RCP85/HSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Resilience")

# Proportional composition
propBiomass_MIROC_ESM_CHEM_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Resilience",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_MIROC_ESM_CHEM_RCP85_Resilience_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Resilience")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_MIROC_ESM_CHEM_RCP85_Resilience <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP85", Model = "MIROC-ESM-CHEM_RCP85") %>%
  mutate(Prescription = "Resilience")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85")

#----BIODIVERSITY----#
diversity_MIROC_ESM_CHEM_RCP85_Resilience <- propBiomass_MIROC_ESM_CHEM_RCP85_Resilience[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_MIROC_ESM_CHEM_RCP85_Resilience <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

successionLog_MIROC_ESM_CHEM_RCP85_Resilience_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "MIROC-ESM-CHEM_RCP85", RCP = "RCP85", Prescription = "Resilience")
  results[[i]] <- df
}
AWB_MIROC_ESM_CHEM_RCP85_ResilienceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")

```

### LSHV (MRI-CGCM3)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resilience/RCP85/LSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_MRI_CGCM3_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Resilience")

# Proportional composition
propBiomass_MRI_CGCM3_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Resilience",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_MRI_CGCM3_RCP85_Resilience_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Resilience")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_MRI_CGCM3_RCP85_Resilience <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP85", Model = "MRI-CGCM3_RCP85") %>%
  mutate(Prescription = "Resilience")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MRI-CGCM3_RCP85")

#----BIODIVERSITY----#
diversity_MRI_CGCM3_RCP85_Resilience <- propBiomass_MRI_CGCM3_RCP85_Resilience[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_MRI_CGCM3_RCP85_Resilience <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

successionLog_MRI_CGCM3_RCP85_Resilience_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "MRI-CGCM3_RCP85", RCP = "RCP85", Prescription = "Resilience")
  results[[i]] <- df
}
AWB_MRI_CGCM3_RCP85_ResilienceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### LSLV (CCSM4)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resilience/RCP85/LSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_CCSM4_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Resilience")

# Proportional composition
propBiomass_CCSM4_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Resilience",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_CCSM4_RCP85_Resilience_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Resilience")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_CCSM4_RCP85_Resilience <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP85", Model = "CCSM4_RCP85") %>%
  mutate(Prescription = "Resilience")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "CCSM4_RCP85")

#----BIODIVERSITY----#
diversity_CCSM4_RCP85_Resilience <- propBiomass_CCSM4_RCP85_Resilience[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_CCSM4_RCP85_Resilience <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

successionLog_CCSM4_RCP85_Resilience_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "CCSM4_RCP85", RCP = "RCP85", Prescription = "Resilience")
  results[[i]] <- df
}
AWB_CCSM4_RCP85_ResilienceDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

# TRANSITION
## RCP45
### HSHV (BNU-ESM)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP45/HSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_BNU_ESM_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "BNU-ESM_RCP45",
         Prescription = "Transition")

# Proportional composition
propBiomass_BNU_ESM_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "BNU-ESM_RCP45",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_BNU_ESM_RCP45_Transition_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP45",
         Model = "BNU-ESM_RCP45",
         Prescription = "Transition")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_BNU_ESM_RCP45_Transition <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP45", Model = "BNU-ESM_RCP45") %>%
  mutate(Prescription = "Transition")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
BNU_ESM_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "BNU-ESM_RCP45")

#----BIODIVERSITY----#
diversity_BNU_ESM_RCP45_Transition <- propBiomass_BNU_ESM_RCP45_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_BNU_ESM_RCP45_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")

successionLog_BNU_ESM_RCP45_Transition_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "BNU-ESM_RCP45", RCP = "RCP45", Prescription = "Transition")
  results[[i]] <- df
}
AWB_BNU_ESM_RCP45_TransitionDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### HSLV (MIROC-ESM-CHEM)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP45/HSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_MIROC_ESM_CHEM_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "MIROC-ESM-CHEM_RCP45",
         Prescription = "Transition")

# Proportional composition
propBiomass_MIROC_ESM_CHEM_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "MIROC-ESM-CHEM_RCP45",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_MIROC_ESM_CHEM_RCP45_Transition_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP45",
         Model = "MIROC-ESM-CHEM_RCP45",
         Prescription = "Transition")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_MIROC_ESM_CHEM_RCP45_Transition <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP45", Model = "MIROC-ESM-CHEM_RCP45") %>%
  mutate(Prescription = "Transition")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45")

#----BIODIVERSITY----#
diversity_MIROC_ESM_CHEM_RCP45_Transition <- propBiomass_MIROC_ESM_CHEM_RCP45_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_MIROC_ESM_CHEM_RCP45_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")

successionLog_MIROC_ESM_CHEM_RCP45_Transition_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "MIROC-ESM-CHEM_RCP45", RCP = "RCP45", Prescription = "Transition")
  results[[i]] <- df
}
AWB_MIROC_ESM_CHEM_RCP45_TransitionDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### LSHV (MRI-CGCM3)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP45/LSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_MRI_CGCM3_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "MRI-CGCM3_RCP45",
         Prescription = "Transition")

# Proportional composition
propBiomass_MRI_CGCM3_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "MRI-CGCM3_RCP45",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_MRI_CGCM3_RCP45_Transition_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP45",
         Model = "MRI-CGCM3_RCP45",
         Prescription = "Transition")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_MRI_CGCM3_RCP45_Transition <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP45", Model = "MRI-CGCM3_RCP45") %>%
  mutate(Prescription = "Transition")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MRI_CGCM3_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MRI-CGCM3_RCP45")

#----BIODIVERSITY----#
diversity_MRI_CGCM3_RCP45_Transition <- propBiomass_MRI_CGCM3_RCP45_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_MRI_CGCM3_RCP45_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")

successionLog_MRI_CGCM3_RCP45_Transition_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "MRI-CGCM3_RCP45", RCP = "RCP45", Prescription = "Transition")
  results[[i]] <- df
}
AWB_MRI_CGCM3_RCP45_TransitionDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### LSLV (CCSM4)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP45/LSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_CCSM4_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "CCSM4_RCP45",
         Prescription = "Transition")

# Proportional composition
propBiomass_CCSM4_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "CCSM4_RCP45",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_CCSM4_RCP45_Transition_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP45",
         Model = "CCSM4_RCP45",
         Prescription = "Transition")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_CCSM4_RCP45_Transition <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP45", Model = "CCSM4_RCP45") %>%
  mutate(Prescription = "Transition")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
CCSM4_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "CCSM4_RCP45")

#----BIODIVERSITY----#
diversity_CCSM4_RCP45_Transition <- propBiomass_CCSM4_RCP45_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_CCSM4_RCP45_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")

successionLog_CCSM4_RCP45_Transition_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "CCSM4_RCP45", RCP = "RCP45", Prescription = "Transition")
  results[[i]] <- df
}
AWB_CCSM4_RCP45_TransitionDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")

```

## RCP85
### HSHV (BNU-ESM)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP85/HSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_BNU_ESM_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Transition")

# Proportional composition
propBiomass_BNU_ESM_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_BNU_ESM_RCP85_Transition_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Transition")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_BNU_ESM_RCP85_Transition <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP85", Model = "BNU-ESM_RCP85") %>%
  mutate(Prescription = "Transition")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
BNU_ESM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "BNU-ESM_RCP85")

#----BIODIVERSITY----#
diversity_BNU_ESM_RCP85_Transition <- propBiomass_BNU_ESM_RCP85_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_BNU_ESM_RCP85_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")

successionLog_BNU_ESM_RCP85_Transition_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "BNU-ESM_RCP85", RCP = "RCP85", Prescription = "Transition")
  results[[i]] <- df
}
AWB_BNU_ESM_RCP85_TransitionDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### HSLV (MIROC-ESM-CHEM)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP85/HSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_MIROC_ESM_CHEM_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Transition")

# Proportional composition
propBiomass_MIROC_ESM_CHEM_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_MIROC_ESM_CHEM_RCP85_Transition_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Transition")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_MIROC_ESM_CHEM_RCP85_Transition <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP85", Model = "MIROC-ESM-CHEM_RCP85") %>%
  mutate(Prescription = "Transition")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85")

#----BIODIVERSITY----#
diversity_MIROC_ESM_CHEM_RCP85_Transition <- propBiomass_MIROC_ESM_CHEM_RCP85_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_MIROC_ESM_CHEM_RCP85_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")

successionLog_MIROC_ESM_CHEM_RCP85_Transition_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "MIROC-ESM-CHEM_RCP85", RCP = "RCP85", Prescription = "Transition")
  results[[i]] <- df
}
AWB_MIROC_ESM_CHEM_RCP85_TransitionDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### LSHV (MRI-CGCM3)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP85/LSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_MRI_CGCM3_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Transition")

# Proportional composition
propBiomass_MRI_CGCM3_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_MRI_CGCM3_RCP85_Transition_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Transition")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_MRI_CGCM3_RCP85_Transition <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP85", Model = "MRI-CGCM3_RCP85") %>%
  mutate(Prescription = "Transition")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MRI_CGCM3_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MRI-CGCM3_RCP85")

#----BIODIVERSITY----#
diversity_MRI_CGCM3_RCP85_Transition <- propBiomass_MRI_CGCM3_RCP85_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_MRI_CGCM3_RCP85_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")

successionLog_MRI_CGCM3_RCP85_Transition_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "MRI-CGCM3_RCP85", RCP = "RCP85", Prescription = "Transition")
  results[[i]] <- df
}
AWB_MRI_CGCM3_RCP85_TransitionDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")
```

### LSLV (CCSM4)

```{r, message = FALSE, warning = FALSE}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP85/LSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_CCSM4_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Transition")

# Proportional composition
propBiomass_CCSM4_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

propBiomass_CCSM4_RCP85_Transition_AllRuns <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Run) %>% # Group by time and run
  mutate(Percent_Biomass = Biomass_MG / sum(Biomass_MG, na.rm = TRUE) * 100,
         RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Transition")

#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
harvest_CCSM4_RCP85_Transition <- do.call(rbind, combinedData) %>%
  mutate(Prescription_Type = Prescription, RCP = "RCP85", Model = "CCSM4_RCP85") %>%
  mutate(Prescription = "Transition")

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
CCSM4_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "CCSM4_RCP85")

#----BIODIVERSITY----#
diversity_CCSM4_RCP85_Transition <- propBiomass_CCSM4_RCP85_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")

#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
successionLog_CCSM4_RCP85_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")

successionLog_CCSM4_RCP85_Transition_All <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time, Run) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}

results <- list()
for (i in 1:8) {
  indices <- seq(i, 33 + i, by = 8)
  df <- c(combinedRasters[[indices[1]]], combinedRasters[[indices[2]]], combinedRasters[[indices[3]]], 
          combinedRasters[[indices[4]]], combinedRasters[[indices[5]]]) %>%
    as.data.frame() %>%
    `colnames<-`(c("run1", "run2", "run3", "run4", "run5")) %>%
    pivot_longer(cols = "run1":"run5", values_to = "AWB", names_to = "Run") %>%
    filter(AWB > 0) %>%
    group_by(Run) %>%
    summarise(AWB = mean(AWB)) %>%
    mutate(Time = i * 10, Model = "CCSM4_RCP85", RCP = "RCP85", Prescription = "Transition")
  results[[i]] <- df
}
AWB_CCSM4_RCP85_TransitionDf <- bind_rows(results)

#----STRUCTURAL DIVERSITY----#
# combinedData <- list()
# index <- 1
# 
# for (run in runs) {
#   runDir <- file.path(mainDir, run)
#   for (year in seq(0, 80, by = 10)) {
#     filename <- paste0("community-input-file-", year, ".csv")
#     filePath <- file.path(runDir, filename)
#     data <- fread(filePath)
#     data <- data %>% mutate(across(where(is.double), as.integer))
#     data$Run <- run
#     data$Time <- year
#     combinedData[[index]] <- data
#     index <- index + 1
#   }
# }
# 
# combinedData <- do.call(rbind, lapply(seq_along(combinedData), function(i) {
#   df <- combinedData[[i]]
#   return(df)
# }))
# 
# fwrite(combinedData,
#        file = "C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/combinedData.csv")

```

# Final Data
## Climate

```{r}
## Temperature
rbind(BNU_ESM_RCP45, MIROC_ESM_CHEM_RCP45, MRI_CGCM3_RCP45,CCSM4_RCP45,BNU_ESM_RCP85, MIROC_ESM_CHEM_RCP85, MRI_CGCM3_RCP85,CCSM4_RCP85) %>%
  ggplot(., aes(x = Year, y = airtemp, col = Model)) +
  geom_line() +
  theme_classic() +
  ylab("Mean Air Temp (°C)")

rbind(BNU_ESM_RCP45, MIROC_ESM_CHEM_RCP45, MRI_CGCM3_RCP45, CCSM4_RCP45, BNU_ESM_RCP85, MIROC_ESM_CHEM_RCP85, MRI_CGCM3_RCP85, CCSM4_RCP85) %>%
  mutate(RCP = ifelse(grepl("45", Model), "RCP45", "RCP85")) %>%
  ggplot(., aes(x = Year, y = airtemp, col = Model)) +
  geom_line() +
  theme_classic() +
  ylab("Mean Air Temp (°C)") +
  facet_wrap(~RCP)

## Precipitation
rbind(BNU_ESM_RCP45, MIROC_ESM_CHEM_RCP45, MRI_CGCM3_RCP45,CCSM4_RCP45,BNU_ESM_RCP85, MIROC_ESM_CHEM_RCP85, MRI_CGCM3_RCP85,CCSM4_RCP85) %>%
  ggplot(., aes(x = Year, y = sumppt, col = Model)) +
  geom_line() +
  theme_classic() +
  ylab("Total Precipitation (mm)")

rbind(BNU_ESM_RCP45, MIROC_ESM_CHEM_RCP45, MRI_CGCM3_RCP45, CCSM4_RCP45, BNU_ESM_RCP85, MIROC_ESM_CHEM_RCP85, MRI_CGCM3_RCP85, CCSM4_RCP85) %>%
  mutate(RCP = ifelse(grepl("45", Model), "RCP45", "RCP85")) %>%
  ggplot(., aes(x = Year, y = sumppt, col = Model)) +
  geom_line() +
  theme_classic() +
  ylab("Total Precipitation (mm)") +
  facet_wrap(~RCP)
```

## Harvesting
### Residual Biomass
#### RCP & Climate Model

```{r}
#----RESISTANCE----#
# Residual Biomass by Species, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP45_Resistance,sppBiomass_BNU_ESM_RCP85_Resistance,sppBiomass_CCSM4_RCP45_Resistance,sppBiomass_CCSM4_RCP85_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP45_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP85_Resistance,sppBiomass_MRI_CGCM3_RCP45_Resistance,sppBiomass_MRI_CGCM3_RCP85_Resistance) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (kg/m2)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# Residual Biomass by Functional Group, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP45_Resistance,sppBiomass_BNU_ESM_RCP85_Resistance,sppBiomass_CCSM4_RCP45_Resistance,sppBiomass_CCSM4_RCP85_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP45_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP85_Resistance,sppBiomass_MRI_CGCM3_RCP45_Resistance,sppBiomass_MRI_CGCM3_RCP85_Resistance) %>%
  filter(Time < 81) %>%
  mutate(FunctionalGroup = ifelse(Species %in% softwoods, "Softwood",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods"))) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (kg/m2)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# Proportional Biomass by Species, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP45_Resistance,propBiomass_BNU_ESM_RCP85_Resistance,propBiomass_CCSM4_RCP45_Resistance,propBiomass_CCSM4_RCP85_Resistance,propBiomass_MIROC_ESM_CHEM_RCP45_Resistance,propBiomass_MIROC_ESM_CHEM_RCP85_Resistance,propBiomass_MRI_CGCM3_RCP45_Resistance,propBiomass_MRI_CGCM3_RCP85_Resistance) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)

# Proportional Biomass by Functional Group, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP45_Resistance,propBiomass_BNU_ESM_RCP85_Resistance,propBiomass_CCSM4_RCP45_Resistance,propBiomass_CCSM4_RCP85_Resistance,propBiomass_MIROC_ESM_CHEM_RCP45_Resistance,propBiomass_MIROC_ESM_CHEM_RCP85_Resistance,propBiomass_MRI_CGCM3_RCP45_Resistance,propBiomass_MRI_CGCM3_RCP85_Resistance) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)

#----RESILIENCE----#
# Residual Biomass by Species, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP45_Resilience,sppBiomass_BNU_ESM_RCP85_Resilience,sppBiomass_CCSM4_RCP45_Resilience,sppBiomass_CCSM4_RCP85_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP45_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience,sppBiomass_MRI_CGCM3_RCP45_Resilience,sppBiomass_MRI_CGCM3_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (kg/m2)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# Residual Biomass by Functional Group, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP45_Resilience,sppBiomass_BNU_ESM_RCP85_Resilience,sppBiomass_CCSM4_RCP45_Resilience,sppBiomass_CCSM4_RCP85_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP45_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience,sppBiomass_MRI_CGCM3_RCP45_Resilience,sppBiomass_MRI_CGCM3_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  mutate(FunctionalGroup = ifelse(Species %in% softwoods, "Softwood",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods"))) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (kg/m2)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# Proportional Biomass by Species, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP45_Resilience,propBiomass_BNU_ESM_RCP85_Resilience,propBiomass_CCSM4_RCP45_Resilience,propBiomass_CCSM4_RCP85_Resilience,propBiomass_MIROC_ESM_CHEM_RCP45_Resilience,propBiomass_MIROC_ESM_CHEM_RCP85_Resilience,propBiomass_MRI_CGCM3_RCP45_Resilience,propBiomass_MRI_CGCM3_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)

# Proportional Biomass by Functional Group, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP45_Resilience,propBiomass_BNU_ESM_RCP85_Resilience,propBiomass_CCSM4_RCP45_Resilience,propBiomass_CCSM4_RCP85_Resilience,propBiomass_MIROC_ESM_CHEM_RCP45_Resilience,propBiomass_MIROC_ESM_CHEM_RCP85_Resilience,propBiomass_MRI_CGCM3_RCP45_Resilience,propBiomass_MRI_CGCM3_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)

#----TRANSITION----#
# Residual Biomass by Species, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP45_Transition,sppBiomass_BNU_ESM_RCP85_Transition,sppBiomass_CCSM4_RCP45_Transition,sppBiomass_CCSM4_RCP85_Transition,sppBiomass_MIROC_ESM_CHEM_RCP45_Transition,sppBiomass_MIROC_ESM_CHEM_RCP85_Transition,sppBiomass_MRI_CGCM3_RCP45_Transition,sppBiomass_MRI_CGCM3_RCP85_Transition) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (kg/m2)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# Residual Biomass by Functional Group, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP45_Transition,sppBiomass_BNU_ESM_RCP85_Transition,sppBiomass_CCSM4_RCP45_Transition,sppBiomass_CCSM4_RCP85_Transition,sppBiomass_MIROC_ESM_CHEM_RCP45_Transition,sppBiomass_MIROC_ESM_CHEM_RCP85_Transition,sppBiomass_MRI_CGCM3_RCP45_Transition,sppBiomass_MRI_CGCM3_RCP85_Transition) %>%
  filter(Time < 81) %>%
  mutate(FunctionalGroup = ifelse(Species %in% softwoods, "Softwood",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods"))) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (kg/m2)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# Proportional Biomass by Species, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP45_Transition,propBiomass_BNU_ESM_RCP85_Transition,propBiomass_CCSM4_RCP45_Transition,propBiomass_CCSM4_RCP85_Transition,propBiomass_MIROC_ESM_CHEM_RCP45_Transition,propBiomass_MIROC_ESM_CHEM_RCP85_Transition,propBiomass_MRI_CGCM3_RCP45_Transition,propBiomass_MRI_CGCM3_RCP85_Transition) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)

# Proportional Biomass by Functional Group, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP45_Transition,propBiomass_BNU_ESM_RCP85_Transition,propBiomass_CCSM4_RCP45_Transition,propBiomass_CCSM4_RCP85_Transition,propBiomass_MIROC_ESM_CHEM_RCP45_Transition,propBiomass_MIROC_ESM_CHEM_RCP85_Transition,propBiomass_MRI_CGCM3_RCP45_Transition,propBiomass_MRI_CGCM3_RCP85_Transition) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)

###################################################

rbind(sppBiomass_BNU_ESM_RCP45_Resistance,sppBiomass_BNU_ESM_RCP85_Resistance,sppBiomass_CCSM4_RCP45_Resistance,sppBiomass_CCSM4_RCP85_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP45_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP85_Resistance,sppBiomass_MRI_CGCM3_RCP45_Resistance,sppBiomass_MRI_CGCM3_RCP85_Resistance) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (kg/m2)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

rbind(sppBiomass_BNU_ESM_RCP45_Resilience,sppBiomass_BNU_ESM_RCP85_Resilience,sppBiomass_CCSM4_RCP45_Resilience,sppBiomass_CCSM4_RCP85_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP45_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience,sppBiomass_MRI_CGCM3_RCP45_Resilience,sppBiomass_MRI_CGCM3_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (kg/m2)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

rbind(sppBiomass_BNU_ESM_RCP45_Transition,sppBiomass_BNU_ESM_RCP85_Transition,sppBiomass_CCSM4_RCP45_Transition,sppBiomass_CCSM4_RCP85_Transition,sppBiomass_MIROC_ESM_CHEM_RCP45_Transition,sppBiomass_MIROC_ESM_CHEM_RCP85_Transition,sppBiomass_MRI_CGCM3_RCP45_Transition,sppBiomass_MRI_CGCM3_RCP85_Transition) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (kg/m2)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# RCP & Model
sppBiomassDfAll %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  group_by(Time, Species, RCP, Model) %>%
  summarise(Biomass_MG = mean(Biomass_MG)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_wrap(RCP~Model, ncol = 4)

# RCP & Prescription
sppBiomassDfAll %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  group_by(Time, Species, Prescription, RCP) %>%
  summarise(Biomass_MG = mean(Biomass_MG)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_wrap(RCP~Prescription, ncol = 3)

# Model & Prescription
sppBiomassDfAll %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  group_by(Time, Species, Prescription, Model) %>%
  summarise(Biomass_MG = mean(Biomass_MG)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_wrap(Prescription~Model, ncol = 4)

aov.1 <- aov(Biomass_MG ~ Prescription * RCP * Model, data = sppBiomassDfAll)
summary(aov.1)
TukeyHSD(aov.1)
```


#### Model & Prescription Type

```{r}
#----RCP45----#
# Residual biomass by species, model type and prescription type
rbind(sppBiomass_BNU_ESM_RCP45_Resistance,sppBiomass_BNU_ESM_RCP85_Resistance,sppBiomass_CCSM4_RCP45_Resistance,sppBiomass_CCSM4_RCP85_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP45_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP85_Resistance,sppBiomass_MRI_CGCM3_RCP45_Resistance,sppBiomass_MRI_CGCM3_RCP85_Resistance,sppBiomass_BNU_ESM_RCP45_Resilience,sppBiomass_BNU_ESM_RCP85_Resilience,sppBiomass_CCSM4_RCP45_Resilience,sppBiomass_CCSM4_RCP85_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP45_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience,sppBiomass_MRI_CGCM3_RCP45_Resilience,sppBiomass_MRI_CGCM3_RCP85_Resilience,sppBiomass_BNU_ESM_RCP45_Transition,sppBiomass_BNU_ESM_RCP85_Transition,sppBiomass_CCSM4_RCP45_Transition,sppBiomass_CCSM4_RCP85_Transition,sppBiomass_MIROC_ESM_CHEM_RCP45_Transition,sppBiomass_MIROC_ESM_CHEM_RCP85_Transition,sppBiomass_MRI_CGCM3_RCP45_Transition,sppBiomass_MRI_CGCM3_RCP85_Transition) %>%
  filter(RCP == "RCP45",
         Time < 81) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, col = Species, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(Prescription ~ Model) +
  scale_y_continuous(name = "kg/m2",
                     breaks = c(0,2e3,4e3,6e3,8e3,1e4,1.2e4),
                     labels = c(0,2,4,6,8,10,12)) +
  scale_x_continuous(name = "Year",
                     breaks = c(0,20,40,60,80),
                     labels = c(2020,2040,2060,2080,2100))

# Proportional residual biomass by species, model type and prescription type
rbind(propBiomass_BNU_ESM_RCP45_Resistance,propBiomass_BNU_ESM_RCP85_Resistance,propBiomass_CCSM4_RCP45_Resistance,propBiomass_CCSM4_RCP85_Resistance,propBiomass_MIROC_ESM_CHEM_RCP45_Resistance,propBiomass_MIROC_ESM_CHEM_RCP85_Resistance,propBiomass_MRI_CGCM3_RCP45_Resistance,propBiomass_MRI_CGCM3_RCP85_Resistance,propBiomass_BNU_ESM_RCP45_Resilience,propBiomass_BNU_ESM_RCP85_Resilience,propBiomass_CCSM4_RCP45_Resilience,propBiomass_CCSM4_RCP85_Resilience,propBiomass_MIROC_ESM_CHEM_RCP45_Resilience,propBiomass_MIROC_ESM_CHEM_RCP85_Resilience,propBiomass_MRI_CGCM3_RCP45_Resilience,propBiomass_MRI_CGCM3_RCP85_Resilience,propBiomass_BNU_ESM_RCP45_Transition,propBiomass_BNU_ESM_RCP85_Transition,propBiomass_CCSM4_RCP45_Transition,propBiomass_CCSM4_RCP85_Transition,propBiomass_MIROC_ESM_CHEM_RCP45_Transition,propBiomass_MIROC_ESM_CHEM_RCP85_Transition,propBiomass_MRI_CGCM3_RCP45_Transition,propBiomass_MRI_CGCM3_RCP85_Transition) %>%
  filter(RCP == "RCP45",
         Time < 81) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, col = Species, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(Prescription ~ Model) +
  ylab("Percent Biomass") +
  scale_x_continuous(name = "Year",
                     breaks = c(0,20,40,60,80),
                     labels = c(2020,2040,2060,2080,2100))

# Residual biomass by functional group, model type and prescription type
rbind(sppBiomass_BNU_ESM_RCP45_Resistance,sppBiomass_BNU_ESM_RCP85_Resistance,sppBiomass_CCSM4_RCP45_Resistance,sppBiomass_CCSM4_RCP85_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP45_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP85_Resistance,sppBiomass_MRI_CGCM3_RCP45_Resistance,sppBiomass_MRI_CGCM3_RCP85_Resistance,sppBiomass_BNU_ESM_RCP45_Resilience,sppBiomass_BNU_ESM_RCP85_Resilience,sppBiomass_CCSM4_RCP45_Resilience,sppBiomass_CCSM4_RCP85_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP45_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience,sppBiomass_MRI_CGCM3_RCP45_Resilience,sppBiomass_MRI_CGCM3_RCP85_Resilience,sppBiomass_BNU_ESM_RCP45_Transition,sppBiomass_BNU_ESM_RCP85_Transition,sppBiomass_CCSM4_RCP45_Transition,sppBiomass_CCSM4_RCP85_Transition,sppBiomass_MIROC_ESM_CHEM_RCP45_Transition,sppBiomass_MIROC_ESM_CHEM_RCP85_Transition,sppBiomass_MRI_CGCM3_RCP45_Transition,sppBiomass_MRI_CGCM3_RCP85_Transition) %>%
  filter(RCP == "RCP45",
         Time < 81) %>%
  mutate(FunctionalGroup = ifelse(Species %in% softwoods, "Softwood",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods"))) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, col = FunctionalGroup, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ Model) +
  scale_y_continuous(name = "kg/m2",
                     breaks = c(0,2e3,4e3,6e3,8e3,1e4,1.2e4),
                     labels = c(0,2,4,6,8,10,12)) +
  scale_x_continuous(name = "Year",
                     breaks = c(0,20,40,60,80),
                     labels = c(2020,2040,2060,2080,2100))

# Proportional residual biomass by functional group, model type and prescription type
rbind(propBiomass_BNU_ESM_RCP45_Resistance,propBiomass_BNU_ESM_RCP85_Resistance,propBiomass_CCSM4_RCP45_Resistance,propBiomass_CCSM4_RCP85_Resistance,propBiomass_MIROC_ESM_CHEM_RCP45_Resistance,propBiomass_MIROC_ESM_CHEM_RCP85_Resistance,propBiomass_MRI_CGCM3_RCP45_Resistance,propBiomass_MRI_CGCM3_RCP85_Resistance,propBiomass_BNU_ESM_RCP45_Resilience,propBiomass_BNU_ESM_RCP85_Resilience,propBiomass_CCSM4_RCP45_Resilience,propBiomass_CCSM4_RCP85_Resilience,propBiomass_MIROC_ESM_CHEM_RCP45_Resilience,propBiomass_MIROC_ESM_CHEM_RCP85_Resilience,propBiomass_MRI_CGCM3_RCP45_Resilience,propBiomass_MRI_CGCM3_RCP85_Resilience,propBiomass_BNU_ESM_RCP45_Transition,propBiomass_BNU_ESM_RCP85_Transition,propBiomass_CCSM4_RCP45_Transition,propBiomass_CCSM4_RCP85_Transition,propBiomass_MIROC_ESM_CHEM_RCP45_Transition,propBiomass_MIROC_ESM_CHEM_RCP85_Transition,propBiomass_MRI_CGCM3_RCP45_Transition,propBiomass_MRI_CGCM3_RCP85_Transition) %>%
  filter(RCP == "RCP45",
         Time < 81) %>%
  mutate(FunctionalGroup = ifelse(Species %in% softwoods, "Softwood",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods"))) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, col = FunctionalGroup, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ Model) +
  ylab("Percent Biomass") +
  scale_x_continuous(name = "Year",
                     breaks = c(0,20,40,60,80),
                     labels = c(2020,2040,2060,2080,2100))

#----RCP85----#
# Residual biomass by species, model type and prescription type
rbind(sppBiomass_BNU_ESM_RCP45_Resistance,sppBiomass_BNU_ESM_RCP85_Resistance,sppBiomass_CCSM4_RCP45_Resistance,sppBiomass_CCSM4_RCP85_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP45_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP85_Resistance,sppBiomass_MRI_CGCM3_RCP45_Resistance,sppBiomass_MRI_CGCM3_RCP85_Resistance,sppBiomass_BNU_ESM_RCP45_Resilience,sppBiomass_BNU_ESM_RCP85_Resilience,sppBiomass_CCSM4_RCP45_Resilience,sppBiomass_CCSM4_RCP85_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP45_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience,sppBiomass_MRI_CGCM3_RCP45_Resilience,sppBiomass_MRI_CGCM3_RCP85_Resilience,sppBiomass_BNU_ESM_RCP45_Transition,sppBiomass_BNU_ESM_RCP85_Transition,sppBiomass_CCSM4_RCP45_Transition,sppBiomass_CCSM4_RCP85_Transition,sppBiomass_MIROC_ESM_CHEM_RCP45_Transition,sppBiomass_MIROC_ESM_CHEM_RCP85_Transition,sppBiomass_MRI_CGCM3_RCP45_Transition,sppBiomass_MRI_CGCM3_RCP85_Transition) %>%
  filter(RCP == "RCP85",
         Time < 81) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, col = Species, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(Prescription ~ Model) +
  scale_y_continuous(name = "kg/m2",
                     breaks = c(0,2e3,4e3,6e3,8e3,1e4,1.2e4),
                     labels = c(0,2,4,6,8,10,12)) +
  scale_x_continuous(name = "Year",
                     breaks = c(0,20,40,60,80),
                     labels = c(2020,2040,2060,2080,2100))


# Proportional residual biomass by species, model type and prescription type
rbind(propBiomass_BNU_ESM_RCP45_Resistance,propBiomass_BNU_ESM_RCP85_Resistance,propBiomass_CCSM4_RCP45_Resistance,propBiomass_CCSM4_RCP85_Resistance,propBiomass_MIROC_ESM_CHEM_RCP45_Resistance,propBiomass_MIROC_ESM_CHEM_RCP85_Resistance,propBiomass_MRI_CGCM3_RCP45_Resistance,propBiomass_MRI_CGCM3_RCP85_Resistance,propBiomass_BNU_ESM_RCP45_Resilience,propBiomass_BNU_ESM_RCP85_Resilience,propBiomass_CCSM4_RCP45_Resilience,propBiomass_CCSM4_RCP85_Resilience,propBiomass_MIROC_ESM_CHEM_RCP45_Resilience,propBiomass_MIROC_ESM_CHEM_RCP85_Resilience,propBiomass_MRI_CGCM3_RCP45_Resilience,propBiomass_MRI_CGCM3_RCP85_Resilience,propBiomass_BNU_ESM_RCP45_Transition,propBiomass_BNU_ESM_RCP85_Transition,propBiomass_CCSM4_RCP45_Transition,propBiomass_CCSM4_RCP85_Transition,propBiomass_MIROC_ESM_CHEM_RCP45_Transition,propBiomass_MIROC_ESM_CHEM_RCP85_Transition,propBiomass_MRI_CGCM3_RCP45_Transition,propBiomass_MRI_CGCM3_RCP85_Transition) %>%
  filter(RCP == "RCP85",
         Time < 81) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, col = Species, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(Prescription ~ Model) +
  ylab("Percent Biomass") +
  scale_x_continuous(name = "Year",
                     breaks = c(0,20,40,60,80),
                     labels = c(2020,2040,2060,2080,2100))

# Residual biomass by functional group, model type and prescription type
rbind(sppBiomass_BNU_ESM_RCP45_Resistance,sppBiomass_BNU_ESM_RCP85_Resistance,sppBiomass_CCSM4_RCP45_Resistance,sppBiomass_CCSM4_RCP85_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP45_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP85_Resistance,sppBiomass_MRI_CGCM3_RCP45_Resistance,sppBiomass_MRI_CGCM3_RCP85_Resistance,sppBiomass_BNU_ESM_RCP45_Resilience,sppBiomass_BNU_ESM_RCP85_Resilience,sppBiomass_CCSM4_RCP45_Resilience,sppBiomass_CCSM4_RCP85_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP45_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience,sppBiomass_MRI_CGCM3_RCP45_Resilience,sppBiomass_MRI_CGCM3_RCP85_Resilience,sppBiomass_BNU_ESM_RCP45_Transition,sppBiomass_BNU_ESM_RCP85_Transition,sppBiomass_CCSM4_RCP45_Transition,sppBiomass_CCSM4_RCP85_Transition,sppBiomass_MIROC_ESM_CHEM_RCP45_Transition,sppBiomass_MIROC_ESM_CHEM_RCP85_Transition,sppBiomass_MRI_CGCM3_RCP45_Transition,sppBiomass_MRI_CGCM3_RCP85_Transition) %>%
  filter(RCP == "RCP85",
         Time < 81) %>%
  mutate(FunctionalGroup = ifelse(Species %in% softwoods, "Softwood",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods"))) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, col = FunctionalGroup, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ Model) +
  scale_y_continuous(name = "kg/m2",
                     breaks = c(0,2e3,4e3,6e3,8e3,1e4,1.2e4),
                     labels = c(0,2,4,6,8,10,12)) +
  scale_x_continuous(name = "Year",
                     breaks = c(0,20,40,60,80),
                     labels = c(2020,2040,2060,2080,2100))

# Proportional residual biomass by functional group, model type and prescription type
rbind(propBiomass_BNU_ESM_RCP45_Resistance,propBiomass_BNU_ESM_RCP85_Resistance,propBiomass_CCSM4_RCP45_Resistance,propBiomass_CCSM4_RCP85_Resistance,propBiomass_MIROC_ESM_CHEM_RCP45_Resistance,propBiomass_MIROC_ESM_CHEM_RCP85_Resistance,propBiomass_MRI_CGCM3_RCP45_Resistance,propBiomass_MRI_CGCM3_RCP85_Resistance,propBiomass_BNU_ESM_RCP45_Resilience,propBiomass_BNU_ESM_RCP85_Resilience,propBiomass_CCSM4_RCP45_Resilience,propBiomass_CCSM4_RCP85_Resilience,propBiomass_MIROC_ESM_CHEM_RCP45_Resilience,propBiomass_MIROC_ESM_CHEM_RCP85_Resilience,propBiomass_MRI_CGCM3_RCP45_Resilience,propBiomass_MRI_CGCM3_RCP85_Resilience,propBiomass_BNU_ESM_RCP45_Transition,propBiomass_BNU_ESM_RCP85_Transition,propBiomass_CCSM4_RCP45_Transition,propBiomass_CCSM4_RCP85_Transition,propBiomass_MIROC_ESM_CHEM_RCP45_Transition,propBiomass_MIROC_ESM_CHEM_RCP85_Transition,propBiomass_MRI_CGCM3_RCP45_Transition,propBiomass_MRI_CGCM3_RCP85_Transition) %>%
  filter(RCP == "RCP85",
         Time < 81) %>%
  mutate(FunctionalGroup = ifelse(Species %in% softwoods, "Softwood",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods"))) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, col = FunctionalGroup, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ Model) +
  ylab("Percent Biomass") +
  scale_x_continuous(name = "Year",
                     breaks = c(0,20,40,60,80),
                     labels = c(2020,2040,2060,2080,2100))

```

#### Harvested Biomass

```{r}
# Make harvestDf dataframe
harvestDf <- rbind(harvest_BNU_ESM_RCP45_Resilience,
                   harvest_BNU_ESM_RCP45_Resistance,
                   harvest_BNU_ESM_RCP45_Transition,
                   harvest_BNU_ESM_RCP85_Resilience,
                   harvest_BNU_ESM_RCP85_Resistance,
                   harvest_BNU_ESM_RCP85_Transition,
                   harvest_MIROC_ESM_CHEM_RCP45_Resilience,
                   harvest_MIROC_ESM_CHEM_RCP45_Resistance,
                   harvest_MIROC_ESM_CHEM_RCP45_Transition,
                   harvest_MIROC_ESM_CHEM_RCP85_Resilience,
                   harvest_MIROC_ESM_CHEM_RCP85_Resistance,
                   harvest_MIROC_ESM_CHEM_RCP85_Transition,
                   harvest_MRI_CGCM3_RCP45_Resilience,
                   harvest_MRI_CGCM3_RCP45_Resistance,
                   harvest_MRI_CGCM3_RCP45_Transition,
                   harvest_MRI_CGCM3_RCP85_Resilience,
                   harvest_MRI_CGCM3_RCP85_Resistance,
                   harvest_MRI_CGCM3_RCP85_Transition,
                   harvest_CCSM4_RCP45_Resilience,
                   harvest_CCSM4_RCP45_Resistance,
                   harvest_CCSM4_RCP45_Transition,
                   harvest_CCSM4_RCP85_Resilience,
                   harvest_CCSM4_RCP85_Resistance,
                   harvest_CCSM4_RCP85_Transition)


harvestDfAll <- harvestDf[,c(1,2,70,38:67,69,3,71,72)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  group_by(Time, Species, Prescription, RCP, Model) %>%
  summarise(Total_Harvest = sum(Harvested_Biomass)) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Model = sub("_[^_]+$", "", Model))


harvestDfAll %>%
  group_by(Time, Species, Prescription, RCP) %>%
  summarise(Total_Harvest = mean(Total_Harvest)) %>%
  ggplot(., aes(x = Time, y = Total_Harvest, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_wrap(RCP~Prescription, ncol = 3)

harvestDfAll %>%
  group_by(Time, Species, Prescription, Model) %>%
  summarise(Total_Harvest = mean(Total_Harvest)) %>%
  ggplot(., aes(x = Time, y = Total_Harvest, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_wrap(Prescription~Model)

harvestDfAll %>%
  group_by(Time, Species, RCP, Model) %>%
  summarise(Total_Harvest = mean(Total_Harvest)) %>%
  ggplot(., aes(x = Time, y = Total_Harvest, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_wrap(RCP~Model, ncol = 4)

aov.1 <- aov(Total_Harvest ~ Prescription * RCP * Model, data = harvestDfAll)
summary(aov.1)
TukeyHSD(aov.1)

# Total harvested biomass by Model & RCP
harvestDf[,c(1,2,70,38:67,69,3,71,72)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription_Type = str_replace(Prescription_Type, "\\s*\\([^)]*\\)", ""),
         Model = sub("_[^_]+$", "", Model)) %>%
  group_by(Model, RCP, Prescription) %>%
  summarise(Total_Harvest = sum(Harvested_Biomass),
            n = n(),
            sd = sd(Harvested_Biomass, na.rm = TRUE),
            se = sd / sqrt(n)) %>%
  ggplot(.) +
  geom_bar(aes(x = Model, y = Total_Harvest, fill = Model), stat = "identity") +
  geom_errorbar(aes(x = Model, ymax = Total_Harvest + sd, ymin = Total_Harvest - sd, color = "red")) +
  theme_classic() +
  scale_y_continuous(name = "Cumulative Biomass Harvested in Millions (Mg)",
                     breaks = c(0,1e8,2e8,3e8,4e8),
                     labels = c(0,100,200,300,400)) +
  facet_wrap(RCP ~ Prescription, nrow = 2)

harvestDf[,c(1,2,70,38:67,69,3,71,72)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription_Type = str_replace(Prescription_Type, "\\s*\\([^)]*\\)", ""),
         Model = sub("_[^_]+$", "", Model)) %>%
  group_by(RCP, Prescription, Model) %>%
  summarise(Total_Harvest = sum(Harvested_Biomass)) %>%
  arrange(desc(Total_Harvest))

# Total harvested biomass by Prescription & RCP
harvestDf[,c(1,2,70,38:67,69,3,71,72)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription_Type = str_replace(Prescription_Type, "\\s*\\([^)]*\\)", ""),
         Model = sub("_[^_]+$", "", Model)) %>%
  group_by(Prescription, RCP) %>%
  summarise(Total_Harvest = sum(Harvested_Biomass)) %>%
  ggplot(., aes(x = Prescription, y = Total_Harvest, fill = Prescription)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  scale_y_continuous(name = "Cumulative Biomass Harvested in Millions (Mg)",
                     breaks = c(0,2e8,4e8,6e8,8e8,1e9,1.2e9),
                     labels = c(0,200,400,600,800,1000,1200)) +
  facet_wrap(~RCP)


# Total amount harvested by Prescription Type and RCP
colours <- c("LOB_PLANTATION" = "#CA6B02","OH_RESISTANCE" = "#52763c","OH_RESILIENCE" = "#83b167","OH_TRANSITION" = "#bad4ab","OP_RESISTANCE" = "#9B111E","OP_RESILIENCE" = "#d31729","OP_TRANSITION" = "#f07984","SOFT_RESISTANCE" = "#0077b6","SOFT_RESILIENCE" = "#15aeff","SOFT_TRANSITION" = "#95daff","THINNING" = "#6930c3")

harvestDf[,c(1,2,70,38:67,69,3,71,72)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription_Type = str_replace(Prescription_Type, "\\s*\\([^)]*\\)", ""),
         Model = sub("_[^_]+$", "", Model)) %>%
  group_by(Prescription_Type, RCP) %>%
  summarise(Total_Harvested = sum(Harvested_Biomass)) %>%
  ggplot(., aes(x = Prescription_Type, y = Total_Harvested, fill = Prescription_Type)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  scale_y_continuous(name = "Cumulative Biomass Harvested in Millions (Mg)",
                     breaks = c(0,2e8,4e8,6e8),
                     labels = c(0,200,400,600)) +
  scale_fill_manual(values = colours) +
  facet_wrap(~RCP)


harvestDf[,c(1,2,70,38:67,69,3,71,72)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription_Type = str_replace(Prescription_Type, "\\s*\\([^)]*\\)", ""),
         Model = sub("_[^_]+$", "", Model)) %>%
  group_by(Prescription_Type, RCP) %>%
  summarise(Total_Harvested = sum(Harvested_Biomass)) %>%
  ggplot(., aes(x = Prescription_Type, y = Total_Harvested, fill = RCP)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_classic() +
  scale_y_continuous(name = "Cumulative Biomass Harvested in Millions (Mg)",
                     breaks = c(0,2e8,4e8,6e8),
                     labels = c(0,200,400,600))

data <- harvestDf[,c(1,2,70,38:67,69,3,71,72)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription_Type = str_replace(Prescription_Type, "\\s*\\([^)]*\\)", ""),
         Model = sub("_[^_]+$", "", Model))


aov.1 <- aov(Harvested_Biomass ~ Prescription_Type * RCP, data = data)
summary(aov.1)
TukeyHSD(aov.1)
```

## NECN Variables

```{r}
#----SUCCESSION LOG----#
successionLog <- rbind(successionLog_BNU_ESM_RCP45_Resilience,
                       successionLog_BNU_ESM_RCP45_Resistance,
                       successionLog_BNU_ESM_RCP45_Transition,
                       successionLog_BNU_ESM_RCP85_Resilience,
                       successionLog_BNU_ESM_RCP85_Resistance,
                       successionLog_BNU_ESM_RCP85_Transition,
                       successionLog_CCSM4_RCP45_Resilience,
                       successionLog_CCSM4_RCP45_Resistance,
                       successionLog_CCSM4_RCP45_Transition,
                       successionLog_CCSM4_RCP85_Resilience,
                       successionLog_CCSM4_RCP85_Resistance,
                       successionLog_CCSM4_RCP85_Transition,
                       successionLog_MIROC_ESM_CHEM_RCP45_Resilience,
                       successionLog_MIROC_ESM_CHEM_RCP45_Resistance,
                       successionLog_MIROC_ESM_CHEM_RCP45_Transition,
                       successionLog_MIROC_ESM_CHEM_RCP85_Resilience,
                       successionLog_MIROC_ESM_CHEM_RCP85_Resistance,
                       successionLog_MIROC_ESM_CHEM_RCP85_Transition,
                       successionLog_MRI_CGCM3_RCP45_Resilience,
                       successionLog_MRI_CGCM3_RCP45_Resistance,
                       successionLog_MRI_CGCM3_RCP45_Transition,
                       successionLog_MRI_CGCM3_RCP85_Resilience,
                       successionLog_MRI_CGCM3_RCP85_Resistance,
                       successionLog_MRI_CGCM3_RCP85_Transition) %>%
  filter(Time < 81) %>%
  select(-ClimateRegionIndex, -NumSites)

# NEEC
successionLog %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = NEEC, col = Model)) +
  geom_line(alpha = 0) +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(RCP ~ Prescription) +
  scale_x_continuous(name = "Year", breaks = c(0,20,40,60,80), labels = c(2020,2040,2060,2080,2100)) +
  geom_smooth(se = FALSE)

# SOMTC
successionLog %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = SOMTC, col = Model)) +
  geom_line(alpha = 0) +
  theme_classic() +
  ylim(2400,4000) +
  geom_hline(yintercept = 3000, linetype = "dashed") +
  facet_wrap(RCP ~ Prescription) +
  scale_x_continuous(name = "Year", breaks = c(0,20,40,60,80), labels = c(2020,2040,2060,2080,2100)) +
  geom_smooth(se = FALSE)

# NPP
successionLog %>%
  mutate(Model = sub("_[^_]+$", "", Model),
         NPP = (AG_NPPC + BG_NPPC) * 2) %>%
  ggplot(., aes(x = Time, y = NPP, col = Model)) +
  geom_line(alpha = 0, size = 2) +
  theme_classic() +
  facet_wrap(RCP ~ Prescription) +
  scale_x_continuous(name = "Year", breaks = c(0,20,40,60,80), labels = c(2020,2040,2060,2080,2100)) +
  ylab("Total Net Primary Productivity") +
  geom_smooth(se = FALSE, method = "lm")

# TotalN
successionLog %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = TotalN, col = Model)) +
  geom_line(alpha = 0) +
  theme_classic() +
  facet_wrap(RCP ~ Prescription) +
  scale_x_continuous(name = "Year", breaks = c(0,20,40,60,80), labels = c(2020,2040,2060,2080,2100)) +
  ylab("Total N") +
  geom_smooth(se = FALSE)

# Age Mortality
successionLog %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = AgeMortality, col = Model)) +
  geom_line(alpha = 0) +
  theme_classic() +
  facet_wrap(RCP ~ Prescription) +
  scale_x_continuous(name = "Year", breaks = c(0,20,40,60,80), labels = c(2020,2040,2060,2080,2100)) +
  ylab("Senesced Biomass (g/m2)") +
  geom_smooth(se = FALSE)

# Litterfall
successionLog %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Litterfall, col = Model)) +
  geom_line(alpha = 0) +
  theme_classic() +
  facet_wrap(RCP ~ Prescription) +
  scale_x_continuous(name = "Year", breaks = c(0,20,40,60,80), labels = c(2020,2040,2060,2080,2100)) +
  ylab("Litterfall (g/m2)") +
  geom_smooth(se = FALSE)

#----DIVERSITY----#
diversityDf <- rbind(diversity_BNU_ESM_RCP45_Resilience,
      diversity_BNU_ESM_RCP45_Resistance,
      diversity_BNU_ESM_RCP45_Transition,
      diversity_BNU_ESM_RCP85_Resilience,
      diversity_BNU_ESM_RCP85_Resistance,
      diversity_BNU_ESM_RCP85_Transition,
      diversity_CCSM4_RCP45_Resilience,
      diversity_CCSM4_RCP45_Resistance,
      diversity_CCSM4_RCP45_Transition,
      diversity_CCSM4_RCP85_Resilience,
      diversity_CCSM4_RCP85_Resistance,
      diversity_CCSM4_RCP85_Transition,
      diversity_MIROC_ESM_CHEM_RCP45_Resilience,
      diversity_MIROC_ESM_CHEM_RCP45_Resistance,
      diversity_MIROC_ESM_CHEM_RCP45_Transition,
      diversity_MIROC_ESM_CHEM_RCP85_Resilience,
      diversity_MIROC_ESM_CHEM_RCP85_Resistance,
      diversity_MIROC_ESM_CHEM_RCP85_Transition,
      diversity_MRI_CGCM3_RCP45_Resilience,
      diversity_MRI_CGCM3_RCP45_Resistance,
      diversity_MRI_CGCM3_RCP45_Transition,
      diversity_MRI_CGCM3_RCP85_Resilience,
      diversity_MRI_CGCM3_RCP85_Resistance,
      diversity_MRI_CGCM3_RCP85_Transition)

diversityDf %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  filter(Time < 81) %>%
  ggplot(., aes(x = Time, y = H, col = Model)) +
  geom_line(size = 2) +
  theme_classic() +
  facet_grid(RCP ~ Prescription)

#----ANNUAL WATER BUDGET----#
rbind(AWB_BNU_ESM_RCP45_ResistanceDf,
      AWB_BNU_ESM_RCP45_ResilienceDf,
      AWB_BNU_ESM_RCP45_TransitionDf,
      AWB_BNU_ESM_RCP85_ResistanceDf,
      AWB_BNU_ESM_RCP85_ResilienceDf,
      AWB_BNU_ESM_RCP85_TransitionDf,
      AWB_CCSM4_RCP45_ResistanceDf,
      AWB_CCSM4_RCP45_ResilienceDf,
      AWB_CCSM4_RCP45_TransitionDf,
      AWB_CCSM4_RCP85_ResistanceDf,
      AWB_CCSM4_RCP85_ResilienceDf,
      AWB_CCSM4_RCP85_TransitionDf,
      AWB_MIROC_ESM_CHEM_RCP45_ResistanceDf,
      AWB_MIROC_ESM_CHEM_RCP45_ResilienceDf,
      AWB_MIROC_ESM_CHEM_RCP45_TransitionDf,
      AWB_MIROC_ESM_CHEM_RCP85_ResistanceDf,
      AWB_MIROC_ESM_CHEM_RCP85_ResilienceDf,
      AWB_MIROC_ESM_CHEM_RCP85_TransitionDf,
      AWB_MRI_CGCM3_RCP45_ResistanceDf,
      AWB_MRI_CGCM3_RCP45_ResilienceDf,
      AWB_MRI_CGCM3_RCP45_TransitionDf,
      AWB_MRI_CGCM3_RCP85_ResistanceDf,
      AWB_MRI_CGCM3_RCP85_ResilienceDf,
      AWB_MRI_CGCM3_RCP85_TransitionDf) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  # filter(RCP == "RCP85") %>%
  ggplot(., aes(x = as.integer(Time), y = AWB, col = Model)) +
  geom_line(size = 2) +
  theme_classic() +
  facet_wrap(RCP ~ Prescription)


diversityDf %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  filter(Time < 81) %>%
  arrange(desc(H))


successionLog %>%
  mutate(Model = sub("_[^_]+$", "", Model),
         NPP = (AG_NPPC + BG_NPPC) * 2) %>%
  filter(Time < 81) %>%
  select(Time, NPP, Model, RCP, Prescription) %>%
  arrange(desc(NPP))

```

## Reproduction & Establishment

```{r}
# Reproduction
mainDir <- "D:/Landis Outputs"
scenarios <- c("Resistance", "Resilience", "Transition")
rcps <- c("RCP45", "RCP85")
climates <- c("HSHV", "HSLV", "LSHV", "LSLV")
runs <- paste0("run", 1:5)

combinedData <- list()
for (scenario in scenarios) {
  for (rcp in rcps) {
    for (climate in climates) {
      for (run in runs) {
        filePath <- file.path(mainDir, scenario, rcp, climate, run, paste0("NECN-reproduction-log.csv"))
        data <- fread(filePath)
        data$Run <- run
        name <- paste(scenario, rcp, climate, run, sep = "_")
        combinedData[[name]] <- data
        for (name in names(combinedData)) {
          parts <- unlist(strsplit(name, "_"))
          combinedData[[name]]$Prescription <- parts[1]
          combinedData[[name]]$RCP <- parts[2]
          combinedData[[name]]$Model <- parts[3]
        }
      }
    }
  }
}

reproductionDfAll <- rbindlist(combinedData, fill = TRUE) %>% as.data.frame() %>% select(-V7)


reproductionDfAll %>%
  group_by(Time, RCP, Model, SpeciesName) %>%
  summarise(NumCohortsSeed = mean(NumCohortsSeed)) %>%
  ggplot(., aes(x = Time, y = NumCohortsSeed)) +
  geom_line(size = 1, alpha = 0) +
  geom_smooth(se = FALSE, , method = "lm") +
  theme_classic() +
  facet_wrap(RCP~Model, ncol = 4)

reproductionDfAll %>%
  group_by(Time, Prescription, Model, SpeciesName) %>%
  summarise(NumCohortsSeed = mean(NumCohortsSeed)) %>%
  ggplot(., aes(x = Time, y = NumCohortsSeed)) +
  geom_line(size = 1, alpha = 0) +
  geom_smooth(se = FALSE, , method = "lm") +
  theme_classic() +
  facet_wrap(Prescription~Model, ncol = 4)

reproductionDfAll %>%
  group_by(Time, Prescription, RCP, SpeciesName) %>%
  summarise(NumCohortsSeed = mean(NumCohortsSeed)) %>%
  ggplot(., aes(x = Time, y = NumCohortsSeed)) +
  geom_line(size = 1, alpha = 0) +
  geom_smooth(se = FALSE, , method = "lm") +
  theme_classic() +
  facet_wrap(RCP~Prescription, ncol = 3)

# Establishment
combinedData <- list()
for (scenario in scenarios) {
  for (rcp in rcps) {
    for (climate in climates) {
      for (run in runs) {
        filePath <- file.path(mainDir, scenario, rcp, climate, run, paste0("NECN-prob-establish-log.csv"))
        data <- fread(filePath)
        data$Run <- run
        name <- paste(scenario, rcp, climate, run, sep = "_")
        combinedData[[name]] <- data
        for (name in names(combinedData)) {
          parts <- unlist(strsplit(name, "_"))
          combinedData[[name]]$Prescription <- parts[1]
          combinedData[[name]]$RCP <- parts[2]
          combinedData[[name]]$Model <- parts[3]
        }
      }
    }
  }
}

establishmentDfAll <- rbindlist(combinedData, fill = TRUE) %>% as.data.frame() %>% select(-V15)

establishmentDfAll <- establishmentDfAll %>%
  group_by(Time, SpeciesName, Prescription, Model, RCP) %>%
  summarise(AvgProbEst = weighted.mean(x = AvgProbEst, w = rep(c(528897,24948), length.out = n())))

establishmentDfAll %>%
  group_by(Time, RCP, Model, SpeciesName) %>%
  summarise(AvgProbEst = mean(AvgProbEst)) %>%
  ggplot(., aes(x = Time, y = AvgProbEst, col = SpeciesName)) +
  geom_line(size = 1, alpha = 0) +
  geom_smooth(se = FALSE, method = "lm") +
  theme_classic() +
  facet_wrap(RCP~Model, ncol = 4)

establishmentDfAll %>%
  group_by(Time, Prescription, Model, SpeciesName) %>%
  summarise(AvgProbEst = mean(AvgProbEst)) %>%
  ggplot(., aes(x = Time, y = AvgProbEst, col = SpeciesName)) +
  geom_line(size = 1, alpha = 0) +
  geom_smooth(se = FALSE, method = "lm") +
  theme_classic() +
  facet_wrap(Prescription~Model, ncol = 4)

establishmentDfAll %>%
  group_by(Time, Prescription, RCP, SpeciesName) %>%
  summarise(AvgProbEst = mean(AvgProbEst)) %>%
  ggplot(., aes(x = Time, y = AvgProbEst, col = SpeciesName)) +
  geom_line(size = 1, alpha = 0) +
  geom_smooth(se = FALSE, method = "lm") +
  theme_classic() +
  facet_wrap(RCP~Prescription, ncol = 3)

establishmentDfAll %>%
  group_by(Time, Prescription, SpeciesName) %>%
  summarise(AvgProbEst = mean(AvgProbEst)) %>%
  ggplot(., aes(x = Time, y = AvgProbEst, col = SpeciesName)) +
  geom_line(size = 1, alpha = 0) +
  geom_smooth(se = FALSE, method = "lm") +
  theme_classic() +
  facet_wrap(~Prescription)

establishmentDfAll %>%
  group_by(Time, Model, SpeciesName) %>%
  summarise(AvgProbEst = mean(AvgProbEst)) %>%
  ggplot(., aes(x = Time, y = AvgProbEst, col = SpeciesName)) +
  geom_line(size = 1, alpha = 0) +
  geom_smooth(se = FALSE, method = "lm") +
  theme_classic() +
  facet_wrap(~Model, ncol = 4)

establishmentDfAll %>%
  group_by(Time, RCP, SpeciesName) %>%
  summarise(AvgProbEst = mean(AvgProbEst)) %>%
  ggplot(., aes(x = Time, y = AvgProbEst, col = SpeciesName)) +
  geom_line(size = 1, alpha = 0) +
  geom_smooth(se = FALSE, method = "lm") +
  theme_classic() +
  facet_wrap(~RCP)
```


## Maps
## Total Biomass


## Annual Water Budget

```{r}
mainDir <- "D:/Landis Outputs"
scenarios <- c("Resistance", "Resilience", "Transition")
rcps <- c("RCP45", "RCP85")
climates <- c("HSHV", "HSLV", "LSHV", "LSLV")
runs <- paste0("run",1:5)
timesteps <- 80

raster_list <- list()
for (scenario in scenarios) {
  for (rcp in rcps) {
    for (climate in climates){
      for (run in runs) {
        for (timestep in timesteps) {
          img_file <- file.path(mainDir, scenario, rcp, climate, run, paste0("Annual-water-budget-", timestep, ".img"))
          raster <- rast(img_file)
          crs(raster) <- "epsg:26917"
          raster <- flip(raster)
          ext(raster) <- ext(templateRaster)
          # raster <- project(raster, res = 70.71068, templateRaster, method = "bilinear")
          # raster_list[[length(raster_list) + 1]] <- raster
          raster_list[[img_file]] <- raster
        }
      }
    }
  }
}

# Resistance
AWB_Resistance_RCP45_HSHV <- c(raster_list[[1]],raster_list[[2]],raster_list[[3]],raster_list[[4]],raster_list[[5]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resistance_RCP45_HSLV <- c(raster_list[[6]],raster_list[[7]],raster_list[[8]],raster_list[[9]],raster_list[[10]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resistance_RCP45_LSHV <- c(raster_list[[11]],raster_list[[12]],raster_list[[13]],raster_list[[14]],raster_list[[15]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resistance_RCP45_LSLV <- c(raster_list[[16]],raster_list[[17]],raster_list[[18]],raster_list[[19]],raster_list[[20]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resistance_RCP85_HSHV <- c(raster_list[[21]],raster_list[[22]],raster_list[[23]],raster_list[[24]],raster_list[[25]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resistance_RCP85_HSLV <- c(raster_list[[26]],raster_list[[27]],raster_list[[28]],raster_list[[29]],raster_list[[30]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resistance_RCP85_LSHV <- c(raster_list[[31]],raster_list[[32]],raster_list[[33]],raster_list[[34]],raster_list[[35]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resistance_RCP85_LSLV <- c(raster_list[[36]],raster_list[[37]],raster_list[[38]],raster_list[[39]],raster_list[[40]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
resistance_RCP45_AWB_Stack <- c(AWB_Resistance_RCP45_HSHV,AWB_Resistance_RCP45_HSLV,AWB_Resistance_RCP45_LSHV,AWB_Resistance_RCP45_LSLV) %>%
  as.data.frame(xy = TRUE) %>%
  `colnames<-`(c("x","y","BNU-ESM","MIROC-ESM-CHEM","MRI-CGCM3","CCSM4")) %>%
  mutate(RCP = "RCP45", Prescription = "Resistance")
resistance_RCP85_AWB_Stack <- c(AWB_Resistance_RCP85_HSHV,AWB_Resistance_RCP85_HSLV,AWB_Resistance_RCP85_LSHV,AWB_Resistance_RCP85_LSLV) %>%
  as.data.frame(xy = TRUE) %>%
  `colnames<-`(c("x","y","BNU-ESM","MIROC-ESM-CHEM","MRI-CGCM3","CCSM4")) %>%
  mutate(RCP = "RCP85", Prescription = "Resistance")
# Resilience
AWB_Resilience_RCP45_HSHV <- c(raster_list[[41]],raster_list[[42]],raster_list[[43]],raster_list[[44]],raster_list[[45]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resilience_RCP45_HSLV <- c(raster_list[[46]],raster_list[[47]],raster_list[[48]],raster_list[[49]],raster_list[[50]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resilience_RCP45_LSHV <- c(raster_list[[51]],raster_list[[52]],raster_list[[53]],raster_list[[54]],raster_list[[55]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resilience_RCP45_LSLV <- c(raster_list[[56]],raster_list[[57]],raster_list[[58]],raster_list[[59]],raster_list[[60]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resilience_RCP85_HSHV <- c(raster_list[[61]],raster_list[[62]],raster_list[[63]],raster_list[[64]],raster_list[[65]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resilience_RCP85_HSLV <- c(raster_list[[66]],raster_list[[67]],raster_list[[68]],raster_list[[69]],raster_list[[70]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resilience_RCP85_LSHV <- c(raster_list[[71]],raster_list[[72]],raster_list[[73]],raster_list[[74]],raster_list[[75]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Resilience_RCP85_LSLV <- c(raster_list[[76]],raster_list[[77]],raster_list[[78]],raster_list[[79]],raster_list[[80]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
resilience_RCP45_AWB_Stack <- c(AWB_Resilience_RCP45_HSHV,AWB_Resilience_RCP45_HSLV,AWB_Resilience_RCP45_LSHV,AWB_Resilience_RCP45_LSLV) %>%
  as.data.frame(xy = TRUE) %>%
  `colnames<-`(c("x","y","BNU-ESM","MIROC-ESM-CHEM","MRI-CGCM3","CCSM4")) %>%
  mutate(RCP = "RCP45", Prescription = "Resilience")
resilience_RCP85_AWB_Stack <- c(AWB_Resilience_RCP85_HSHV,AWB_Resilience_RCP85_HSLV,AWB_Resilience_RCP85_LSHV,AWB_Resilience_RCP85_LSLV) %>%
  as.data.frame(xy = TRUE) %>%
  `colnames<-`(c("x","y","BNU-ESM","MIROC-ESM-CHEM","MRI-CGCM3","CCSM4")) %>%
  mutate(RCP = "RCP85", Prescription = "Resilience")
# Transition
AWB_Transition_RCP45_HSHV <- c(raster_list[[81]],raster_list[[82]],raster_list[[83]],raster_list[[84]],raster_list[[85]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Transition_RCP45_HSLV <- c(raster_list[[86]],raster_list[[87]],raster_list[[88]],raster_list[[89]],raster_list[[90]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Transition_RCP45_LSHV <- c(raster_list[[91]],raster_list[[92]],raster_list[[93]],raster_list[[94]],raster_list[[95]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Transition_RCP45_LSLV <- c(raster_list[[96]],raster_list[[97]],raster_list[[98]],raster_list[[99]],raster_list[[100]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Transition_RCP85_HSHV <- c(raster_list[[101]],raster_list[[102]],raster_list[[103]],raster_list[[104]],raster_list[[105]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Transition_RCP85_HSLV <- c(raster_list[[106]],raster_list[[107]],raster_list[[108]],raster_list[[109]],raster_list[[110]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Transition_RCP85_LSHV <- c(raster_list[[111]],raster_list[[112]],raster_list[[113]],raster_list[[114]],raster_list[[115]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
AWB_Transition_RCP85_LSLV <- c(raster_list[[116]],raster_list[[117]],raster_list[[118]],raster_list[[119]],raster_list[[110]]) %>% app(., "mean") %>% app(., function(x) ifelse(x == 0, NA, x))
transition_RCP45_AWB_Stack <- c(AWB_Transition_RCP45_HSHV,AWB_Transition_RCP45_HSLV,AWB_Transition_RCP45_LSHV,AWB_Transition_RCP45_LSLV) %>%
  as.data.frame(xy = TRUE) %>%
  `colnames<-`(c("x","y","BNU-ESM","MIROC-ESM-CHEM","MRI-CGCM3","CCSM4")) %>%
  mutate(RCP = "RCP45", Prescription = "Transition")
transition_RCP85_AWB_Stack <- c(AWB_Transition_RCP85_HSHV,AWB_Transition_RCP85_HSLV,AWB_Transition_RCP85_LSHV,AWB_Transition_RCP85_LSLV) %>%
  as.data.frame(xy = TRUE) %>%
  `colnames<-`(c("x","y","BNU-ESM","MIROC-ESM-CHEM","MRI-CGCM3","CCSM4")) %>%
  mutate(RCP = "RCP85", Prescription = "Transition")

final_Resistance_AWB <- rbind(resistance_RCP45_AWB_Stack %>%
  pivot_longer(cols = c("BNU-ESM":"CCSM4"), values_to = "value", names_to = "Model"),
resistance_RCP85_AWB_Stack %>%
  pivot_longer(cols = c("BNU-ESM":"CCSM4"), values_to = "value", names_to = "Model"))

final_Resilience_AWB <- rbind(resilience_RCP45_AWB_Stack %>%
  pivot_longer(cols = c("BNU-ESM":"CCSM4"), values_to = "value", names_to = "Model"),
resilience_RCP85_AWB_Stack %>%
  pivot_longer(cols = c("BNU-ESM":"CCSM4"), values_to = "value", names_to = "Model"))

final_Transition_AWB <- rbind(transition_RCP45_AWB_Stack %>%
  pivot_longer(cols = c("BNU-ESM":"CCSM4"), values_to = "value", names_to = "Model"),
transition_RCP85_AWB_Stack %>%
  pivot_longer(cols = c("BNU-ESM":"CCSM4"), values_to = "value", names_to = "Model"))

final_AWB <- rbind(final_Resilience_AWB, final_Resistance_AWB, final_Transition_AWB)

ggplot(final_Resistance_AWB) +
  geom_raster(aes(x = x, y = y, fill = value)) +
  scale_fill_gradient(low = "#a8dadc", high = "#1d3557", name = "AWB") +
  theme_classic() +
  facet_wrap(RCP ~ Model, ncol = 4)

ggplot(final_Resilience_AWB) +
  geom_raster(aes(x = x, y = y, fill = value)) +
  scale_fill_gradient(low = "#a8dadc", high = "#1d3557", name = "AWB") +
  theme_classic() +
  facet_wrap(RCP ~ Model, ncol = 4)

ggplot(final_Transition_AWB) +
  geom_raster(aes(x = x, y = y, fill = value)) +
  scale_fill_gradient(low = "#a8dadc", high = "#1d3557", name = "AWB") +
  theme_classic() +
  facet_wrap(RCP ~ Model, ncol = 4)



ggplot(final_AWB, aes(x = Model, y = value, fill = Model)) +
  geom_violin(width = 1) +
  geom_boxplot(width = 0.05) +
  theme_classic() +
  facet_wrap(RCP~Prescription)



```


### Total Carbon

```{r}
mainDir <- "D:/Landis Outputs"
scenarios <- c("Resistance", "Resilience", "Transition") # Fill in with Resilience
rcps <- c("RCP45", "RCP85")
climates <- c("HSHV", "HSLV", "LSHV", "LSLV")
runs <- paste0("run",1:5)

raster_list <- list()
for (scenario in scenarios) {
  for (rcp in rcps) {
    for (climate in climates){
      for (run in runs) {
        for (timestep in timesteps) {
          img_file <- file.path(mainDir, scenario, rcp, climate, run, paste0("TotalC-", timestep, ".img"))
          raster <- rast(img_file)
          crs(raster) <- "epsg:26917"
          raster <- flip(raster)
          ext(raster) <- ext(templateRaster)
          # raster <- project(raster, res = 70.71068, templateRaster, method = "bilinear")
          raster_list[[length(raster_list) + 1]] <- raster
        }
      }
    }
  }
}

# Resistance
TotalC_Resistance_RCP45_HSHV <- c(raster_list[[1]],raster_list[[2]],raster_list[[3]],raster_list[[4]],raster_list[[5]]) %>% app(., "mean")
TotalC_Resistance_RCP45_HSLV <- c(raster_list[[6]],raster_list[[7]],raster_list[[8]],raster_list[[9]],raster_list[[10]]) %>% app(., "mean")
TotalC_Resistance_RCP45_LSHV <- c(raster_list[[11]],raster_list[[12]],raster_list[[13]],raster_list[[14]],raster_list[[15]]) %>% app(., "mean")
TotalC_Resistance_RCP45_LSLV <- c(raster_list[[16]],raster_list[[17]],raster_list[[18]],raster_list[[19]],raster_list[[20]]) %>% app(., "mean")
TotalC_Resistance_RCP85_HSHV <- c(raster_list[[21]],raster_list[[22]],raster_list[[23]],raster_list[[24]],raster_list[[25]]) %>% app(., "mean")
TotalC_Resistance_RCP85_HSLV <- c(raster_list[[26]],raster_list[[27]],raster_list[[28]],raster_list[[29]],raster_list[[30]]) %>% app(., "mean")
TotalC_Resistance_RCP85_LSHV <- c(raster_list[[31]],raster_list[[32]],raster_list[[33]],raster_list[[34]],raster_list[[35]]) %>% app(., "mean")
TotalC_Resistance_RCP85_LSLV <- c(raster_list[[36]],raster_list[[37]],raster_list[[38]],raster_list[[39]],raster_list[[40]]) %>% app(., "mean")
resistance_RCP45_C_Stack <- c(TotalC_Resistance_RCP45_HSHV,TotalC_Resistance_RCP45_HSLV,TotalC_Resistance_RCP45_LSHV,TotalC_Resistance_RCP45_LSLV) %>%
  as.data.frame(xy = TRUE) %>%
  `colnames<-`(c("x","y","BNU-ESM","MIROC-ESM-CHEM","MRI-CGCM3","CCSM4")) %>%
  mutate(RCP = "RCP45", Presription = "Resistance")
resistance_RCP85_C_Stack <- c(TotalC_Resistance_RCP85_HSHV,TotalC_Resistance_RCP85_HSLV,TotalC_Resistance_RCP85_LSHV,TotalC_Resistance_RCP85_LSLV) %>%
  as.data.frame(xy = TRUE) %>%
  `colnames<-`(c("x","y","BNU-ESM","MIROC-ESM-CHEM","MRI-CGCM3","CCSM4")) %>%
  mutate(RCP = "RCP85", Presription = "Resistance")
# Resilience
TotalC_Resilience_RCP45_HSHV <- c(raster_list[[41]],raster_list[[42]],raster_list[[43]],raster_list[[44]],raster_list[[45]]) %>% app(., "mean")
TotalC_Resilience_RCP45_HSLV <- c(raster_list[[46]],raster_list[[47]],raster_list[[48]],raster_list[[49]],raster_list[[50]]) %>% app(., "mean")
TotalC_Resilience_RCP45_LSHV <- c(raster_list[[51]],raster_list[[52]],raster_list[[53]],raster_list[[54]],raster_list[[55]]) %>% app(., "mean")
TotalC_Resilience_RCP45_LSLV <- c(raster_list[[56]],raster_list[[57]],raster_list[[58]],raster_list[[59]],raster_list[[60]]) %>% app(., "mean")
TotalC_Resilience_RCP85_HSHV <- c(raster_list[[61]],raster_list[[62]],raster_list[[63]],raster_list[[64]],raster_list[[65]]) %>% app(., "mean")
TotalC_Resilience_RCP85_HSLV <- c(raster_list[[66]],raster_list[[67]],raster_list[[68]],raster_list[[69]],raster_list[[70]]) %>% app(., "mean")
TotalC_Resilience_RCP85_LSHV <- c(raster_list[[71]],raster_list[[72]],raster_list[[73]],raster_list[[74]],raster_list[[75]]) %>% app(., "mean")
TotalC_Resilience_RCP85_LSLV <- c(raster_list[[76]],raster_list[[77]],raster_list[[78]],raster_list[[79]],raster_list[[80]]) %>% app(., "mean")
resilience_RCP45_C_Stack <- c(TotalC_Resilience_RCP45_HSHV,TotalC_Resilience_RCP45_HSLV,TotalC_Resilience_RCP45_LSHV,TotalC_Resilience_RCP45_LSLV) %>%
  as.data.frame(xy = TRUE) %>%
  `colnames<-`(c("x","y","BNU-ESM","MIROC-ESM-CHEM","MRI-CGCM3","CCSM4")) %>%
  mutate(RCP = "RCP45", Presription = "Resilience")
resilience_RCP85_C_Stack <- c(TotalC_Resilience_RCP85_HSHV,TotalC_Resilience_RCP85_HSLV,TotalC_Resilience_RCP85_LSHV,TotalC_Resilience_RCP85_LSLV) %>%
  as.data.frame(xy = TRUE) %>%
  `colnames<-`(c("x","y","BNU-ESM","MIROC-ESM-CHEM","MRI-CGCM3","CCSM4")) %>%
  mutate(RCP = "RCP85", Presription = "Resilience")
# Transition
TotalC_Transition_RCP45_HSHV <- c(raster_list[[81]],raster_list[[82]],raster_list[[83]],raster_list[[84]],raster_list[[85]]) %>% app(., "mean")
TotalC_Transition_RCP45_HSLV <- c(raster_list[[86]],raster_list[[87]],raster_list[[88]],raster_list[[89]],raster_list[[90]]) %>% app(., "mean")
TotalC_Transition_RCP45_LSHV <- c(raster_list[[91]],raster_list[[92]],raster_list[[93]],raster_list[[94]],raster_list[[95]]) %>% app(., "mean")
TotalC_Transition_RCP45_LSLV <- c(raster_list[[96]],raster_list[[97]],raster_list[[98]],raster_list[[99]],raster_list[[100]]) %>% app(., "mean")
TotalC_Transition_RCP85_HSHV <- c(raster_list[[101]],raster_list[[102]],raster_list[[103]],raster_list[[104]],raster_list[[105]]) %>% app(., "mean")
TotalC_Transition_RCP85_HSLV <- c(raster_list[[106]],raster_list[[107]],raster_list[[108]],raster_list[[109]],raster_list[[110]]) %>% app(., "mean")
TotalC_Transition_RCP85_LSHV <- c(raster_list[[111]],raster_list[[112]],raster_list[[113]],raster_list[[114]],raster_list[[115]]) %>% app(., "mean")
TotalC_Transition_RCP85_LSLV <- c(raster_list[[116]],raster_list[[117]],raster_list[[118]],raster_list[[119]],raster_list[[110]]) %>% app(., "mean")
transition_RCP45_C_Stack <- c(TotalC_Transition_RCP45_HSHV,TotalC_Transition_RCP45_HSLV,TotalC_Transition_RCP45_LSHV,TotalC_Transition_RCP45_LSLV) %>%
  as.data.frame(xy = TRUE) %>%
  `colnames<-`(c("x","y","BNU-ESM","MIROC-ESM-CHEM","MRI-CGCM3","CCSM4")) %>%
  mutate(RCP = "RCP45", Presription = "Transition")
transition_RCP85_C_Stack <- c(TotalC_Transition_RCP85_HSHV,TotalC_Transition_RCP85_HSLV,TotalC_Transition_RCP85_LSHV,TotalC_Transition_RCP85_LSLV) %>%
  as.data.frame(xy = TRUE) %>%
  `colnames<-`(c("x","y","BNU-ESM","MIROC-ESM-CHEM","MRI-CGCM3","CCSM4")) %>%
  mutate(RCP = "RCP85", Presription = "Transition")


final_Resistance_C <- rbind(resistance_RCP45_C_Stack %>%
  pivot_longer(cols = c("BNU-ESM":"CCSM4"), values_to = "value", names_to = "Model"),
  resistance_RCP85_C_Stack %>%
  pivot_longer(cols = c("BNU-ESM":"CCSM4"), values_to = "value", names_to = "Model"))

final_Resilience_C <- rbind(resilience_RCP45_C_Stack %>%
  pivot_longer(cols = c("BNU-ESM":"CCSM4"), values_to = "value", names_to = "Model"),
resilience_RCP85_C_Stack %>%
  pivot_longer(cols = c("BNU-ESM":"CCSM4"), values_to = "value", names_to = "Model"))

final_Transition_C <- rbind(transition_RCP45_C_Stack %>%
  pivot_longer(cols = c("BNU-ESM":"CCSM4"), values_to = "value", names_to = "Model"),
transition_RCP85_C_Stack %>%
  pivot_longer(cols = c("BNU-ESM":"CCSM4"), values_to = "value", names_to = "Model"))


ggplot(final_Resistance_C) +
  geom_raster(aes(x = x, y = y, fill = value)) +
  scale_fill_viridis_c() +
  theme_classic() +
  facet_wrap(RCP ~ Model, ncol = 4)

ggplot(final_Resilience_C) +
  geom_raster(aes(x = x, y = y, fill = value)) +
  scale_fill_viridis_c() +
  theme_classic() +
  facet_wrap(RCP ~ Model, ncol = 4)

ggplot(final_Transition_C) +
  geom_raster(aes(x = x, y = y, fill = value)) +
  scale_fill_viridis_c() +
  theme_classic() +
  facet_wrap(RCP ~ Model, ncol = 4)

#################################################################

mainDir <- "D:/Landis Outputs"
scenarios <- c("Resistance", "Resilience", "Transition") # Fill in with Resilience
rcps <- c("RCP45", "RCP85")
climates <- c("HSHV", "HSLV", "LSHV", "LSLV")
runs <- paste0("run",1:5)
timesteps <- seq(10,80,10)

raster_list <- list()
for (scenario in scenarios) {
  for (rcp in rcps) {
    for (climate in climates) {
      for (run in runs) {
        for (timestep in timesteps) {
          img_file <- file.path(mainDir, scenario, rcp, climate, run, paste0("TotalC-", timestep, ".img"))
          raster <- rast(img_file)
          crs(raster) <- "epsg:26917"
          raster <- flip(raster)
          ext(raster) <- ext(templateRaster)
          
          # Generate a unique name for the raster
          name <- paste(scenario, rcp, climate, run, timestep, sep = "_")
          
          # Assign varname as an attribute to the raster
          names(raster) <- name
          
          # Store raster in list with the same name
          raster_list[[varname]] <- raster
        }
      }
    }
  }
}

raster_means <- list()  # Create a list to store mean values

for (varname in names(raster_list)) {
  raster <- raster_list[[varname]]
  
  # Filter out values that are 0
  raster[raster == 0] <- NA  # Replace 0 with NA
  
  # Calculate the mean, extracting the numeric value
  mean_value <- as.numeric(global(raster, fun = "mean", na.rm = TRUE)[1, 1])
  
  # Store the mean value in the list
  raster_means[[varname]] <- mean_value
}


Total_CDfAll <- raster_means %>%
  as.data.frame() %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  separate(rowname, into = c("Prescription", "RCP", "Model", "Run", "Time"), sep = "_") %>%
  rename(Total_C = V1) %>%
  mutate(Model = ifelse(Model == "HSHV" & RCP == "RCP45", "BNU-ESM_RCP45",
                        ifelse(Model == "HSHV" & RCP == "RCP85", "BNU-ESM-RCP85",
                               ifelse(Model == "HSLV" & RCP == "RCP45", "MIROC-ESM-CHEM_RCP45",
                                      ifelse(Model == "HSLV" & RCP == "RCP85", "MIROC-ESM-CHEM_RCP85",
                                             ifelse(Model == "LSHV" & RCP == "RCP45", "MRI-CGCM3_RCP45",
                                                    ifelse(Model == "LSHV" & RCP == "RCP85", "MRI-CGCM3_RCP85",
                                                           ifelse(Model == "LSLV" & RCP == "RCP45", "CCSM4_RCP45", "CCSM4_RCP85"))))))))
  
```





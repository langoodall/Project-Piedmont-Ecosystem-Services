---
title: "Untitled"
output: pdf_document
date: "2024-12-18"
---

```{r}
library(tidyverse)
library(terra)
library(sf)
options(scipen = 999)
templateRaster <- rast("D:/Landis Outputs/Raster Template/templateRaster.tif")
softwoods <- c("JUVI","PIEC2","PIPA2","PIST","PITA","PIVI2","TAAS","TADI2")
oaks <- c("QUAL","QUCO2","QUFA","QULA3","QUNI","QUPH","QUPR2","QURU","QUST","QUVE")
hardwoods <- c("ACRU","CAAL27","CAGL8","FAGR","FRAM2","FRPE","LIST2","LITU","NYBI","NYSY","OXAR","PRSE2")
```

# RESISTANCE
## RCP45
### HSHV (BNU-ESM)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP45/HSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_BNU_ESM_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "BNU-ESM_RCP45",
         Prescription = "Resistance")


# Proportional composition
propBiomass_BNU_ESM_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "BNU-ESM_RCP45",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
BNU_ESM_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "BNU-ESM_RCP45")


#----BIODIVERSITY----#
diversity_BNU_ESM_RCP45_Resistance <- propBiomass_BNU_ESM_RCP45_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_BNU_ESM_RCP45_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")


#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}
AWB10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
AWB20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
AWB30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
AWB40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
AWB50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
AWB60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
AWB70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
AWB80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
AWBStack_BNU_ESM_RCP45_Resistance <- c(AWB10,AWB20,AWB30,AWB40,AWB50,AWB60,AWB70,AWB80)
plot(AWBStack_BNU_ESM_RCP45_Resistance)
AWBStack_BNU_ESM_RCP45_ResistanceDf <- AWBStack_BNU_ESM_RCP45_Resistance %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "AWB") %>%
  group_by(Time) %>%
  summarise(AWB = mean(AWB)) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")


```

### HSLV (MIROC-ESM-CHEM)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP45/HSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_MIROC_ESM_CHEM_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "MIROC-ESM-CHEM_RCP45",
         Prescription = "Resistance")


# Proportional composition
propBiomass_MIROC_ESM_CHEM_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "MIROC-ESM-CHEM_RCP45",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45")


#----BIODIVERSITY----#
diversity_MIROC_ESM_CHEM_RCP45_Resistance <- propBiomass_MIROC_ESM_CHEM_RCP45_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_MIROC_ESM_CHEM_RCP45_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")


#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}
AWB10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
AWB20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
AWB30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
AWB40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
AWB50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
AWB60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
AWB70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
AWB80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
AWBStack_MIROC_ESM_CHEM_RCP45_Resistance <- c(AWB10,AWB20,AWB30,AWB40,AWB50,AWB60,AWB70,AWB80)
plot(AWBStack_MIROC_ESM_CHEM_RCP45_Resistance)
AWBStack_MIROC_ESM_CHEM_RCP45_ResistanceDf <- AWBStack_MIROC_ESM_CHEM_RCP45_Resistance %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "AWB") %>%
  group_by(Time) %>%
  summarise(AWB = mean(AWB)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

```

### LSHV (MRI-CGCM3)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP45/LSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_MRI_CGCM3_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "MRI-CGCM3_RCP45",
         Prescription = "Resistance")


# Proportional composition
propBiomass_MRI_CGCM3_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "MRI-CGCM3_RCP45",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MRI_CGCM3_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MRI-CGCM3_RCP45")


#----BIODIVERSITY----#
diversity_MRI_CGCM3_RCP45_Resistance <- propBiomass_MRI_CGCM3_RCP45_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_MRI_CGCM3_RCP45_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")


#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}
AWB10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
AWB20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
AWB30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
AWB40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
AWB50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
AWB60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
AWB70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
AWB80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
AWBStack_MRI_CGCM3_RCP45_Resistance <- c(AWB10,AWB20,AWB30,AWB40,AWB50,AWB60,AWB70,AWB80)
plot(AWBStack_MRI_CGCM3_RCP45_Resistance)
AWBStack_MRI_CGCM3_RCP45_ResistanceDf <- AWBStack_MRI_CGCM3_RCP45_Resistance %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "AWB") %>%
  group_by(Time) %>%
  summarise(AWB = mean(AWB)) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")
```

### LSLV (CCSM4)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP45/LSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_CCSM4_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "CCSM4_RCP45",
         Prescription = "Resistance")


# Proportional composition
propBiomass_CCSM4_RCP45_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "CCSM4_RCP45",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
CCSM4_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "CCSM4_RCP45")


#----BIODIVERSITY----#
diversity_CCSM4_RCP45_Resistance <- propBiomass_CCSM4_RCP45_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_CCSM4_RCP45_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")


#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}
AWB10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
AWB20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
AWB30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
AWB40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
AWB50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
AWB60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
AWB70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
AWB80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
AWBStack_CCSM4_RCP45_Resistance <- c(AWB10,AWB20,AWB30,AWB40,AWB50,AWB60,AWB70,AWB80)
plot(AWBStack_CCSM4_RCP45_Resistance)
AWBStack_CCSM4_RCP45_ResistanceDf <- AWBStack_CCSM4_RCP45_Resistance %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "AWB") %>%
  group_by(Time) %>%
  summarise(AWB = mean(AWB)) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Resistance")

```

## RCP85
### HSHV (BNU-ESM)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP85/HSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_BNU_ESM_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Resistance")


# Proportional composition
propBiomass_BNU_ESM_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
BNU_ESM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "BNU-ESM_RCP85")


#----BIODIVERSITY----#
diversity_BNU_ESM_RCP85_Resistance <- propBiomass_BNU_ESM_RCP85_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_BNU_ESM_RCP85_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}
AWB10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
AWB20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
AWB30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
AWB40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
AWB50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
AWB60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
AWB70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
AWB80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
AWBStack_CCSM4_RCP45_Resistance <- c(AWB10,AWB20,AWB30,AWB40,AWB50,AWB60,AWB70,AWB80)
plot(AWBStack_CCSM4_RCP45_Resistance)
AWBStack_CCSM4_RCP45_ResistanceDf <- AWBStack_CCSM4_RCP45_Resistance %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "AWB") %>%
  group_by(Time) %>%
  summarise(AWB = mean(AWB)) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")


```

### HSLV (MIROC-ESM-CHEM)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP85/HSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_MIROC_ESM_CHEM_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Resistance")


# Proportional composition
propBiomass_MIROC_ESM_CHEM_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85")


#----BIODIVERSITY----#
diversity_MIROC_ESM_CHEM_RCP85_Resistance <- propBiomass_MIROC_ESM_CHEM_RCP85_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_MIROC_ESM_CHEM_RCP85_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}
AWB10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
AWB20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
AWB30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
AWB40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
AWB50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
AWB60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
AWB70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
AWB80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
AWBStack_CCSM4_RCP45_Resistance <- c(AWB10,AWB20,AWB30,AWB40,AWB50,AWB60,AWB70,AWB80)
plot(AWBStack_CCSM4_RCP45_Resistance)
AWBStack_CCSM4_RCP45_ResistanceDf <- AWBStack_CCSM4_RCP45_Resistance %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "AWB") %>%
  group_by(Time) %>%
  summarise(AWB = mean(AWB)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")
```

### LSHV (MRI-CGCM3)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP85/LSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_MRI_CGCM3_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Resistance")


# Proportional composition
propBiomass_MRI_CGCM3_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MRI_CGCM3_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MRI-CGCM3_RCP85")


#----BIODIVERSITY----#
diversity_MRI_CGCM3_RCP85_Resistance <- propBiomass_MRI_CGCM3_RCP85_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_MRI_CGCM3_RCP85_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}
AWB10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
AWB20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
AWB30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
AWB40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
AWB50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
AWB60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
AWB70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
AWB80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
AWBStack_CCSM4_RCP45_Resistance <- c(AWB10,AWB20,AWB30,AWB40,AWB50,AWB60,AWB70,AWB80)
plot(AWBStack_CCSM4_RCP45_Resistance)
AWBStack_CCSM4_RCP45_ResistanceDf <- AWBStack_CCSM4_RCP45_Resistance %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "AWB") %>%
  group_by(Time) %>%
  summarise(AWB = mean(AWB)) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")


```

### LSLV (CCSM4)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resistance/RCP85/LSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_CCSM4_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Resistance")


# Proportional composition
propBiomass_CCSM4_RCP85_Resistance <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Resistance",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
CCSM4_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "CCSM4_RCP85")


#----BIODIVERSITY----#
diversity_CCSM4_RCP85_Resistance <- propBiomass_CCSM4_RCP85_Resistance[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_CCSM4_RCP85_Resistance <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}
AWB10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
AWB20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
AWB30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
AWB40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
AWB50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
AWB60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
AWB70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
AWB80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
AWBStack_CCSM4_RCP45_Resistance <- c(AWB10,AWB20,AWB30,AWB40,AWB50,AWB60,AWB70,AWB80)
plot(AWBStack_CCSM4_RCP45_Resistance)
AWBStack_CCSM4_RCP45_ResistanceDf <- AWBStack_CCSM4_RCP45_Resistance %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "AWB") %>%
  group_by(Time) %>%
  summarise(AWB = mean(AWB)) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Resistance")
```

# RESILIENCE
## RCP85
### HSHV (BNU-ESM)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resilience/RCP85/HSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_BNU_ESM_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Resilience")


# Proportional composition
propBiomass_BNU_ESM_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Resilience",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
BNU_ESM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "BNU-ESM_RCP85")


#----BIODIVERSITY----#
diversity_BNU_ESM_RCP85_Resilience <- propBiomass_BNU_ESM_RCP85_Resilience[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_BNU_ESM_RCP85_Resilience <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")


#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}
AWB10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
AWB20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
AWB30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
AWB40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
AWB50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
AWB60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
AWB70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
AWB80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
AWBStack_CCSM4_RCP45_Resilience <- c(AWB10,AWB20,AWB30,AWB40,AWB50,AWB60,AWB70,AWB80)
plot(AWBStack_CCSM4_RCP45_Resilience)
AWBStack_CCSM4_RCP45_ResilienceDf <- AWBStack_CCSM4_RCP45_Resilience %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "AWB") %>%
  group_by(Time) %>%
  summarise(AWB = mean(AWB)) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")
```

### HSLV (MIROC-ESM-CHEM)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resilience/RCP85/HSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Resilience")


# Proportional composition
propBiomass_MIROC_ESM_CHEM_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Resilience",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85")


#----BIODIVERSITY----#
diversity_MIROC_ESM_CHEM_RCP85_Resilience <- propBiomass_MIROC_ESM_CHEM_RCP85_Resilience[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_MIROC_ESM_CHEM_RCP85_Resilience <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}
AWB10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
AWB20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
AWB30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
AWB40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
AWB50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
AWB60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
AWB70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
AWB80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
AWBStack_CCSM4_RCP85_Resilience <- c(AWB10,AWB20,AWB30,AWB40,AWB50,AWB60,AWB70,AWB80)
plot(AWBStack_CCSM4_RCP85_Resilience)
AWBStack_CCSM4_RCP85_ResilienceDf <- AWBStack_CCSM4_RCP85_Resilience %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "AWB") %>%
  group_by(Time) %>%
  summarise(AWB = mean(AWB)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

```

### LSHV (MRI-CGCM3)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resilience/RCP85/LSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_MRI_CGCM3_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Resilience")


# Proportional composition
propBiomass_MRI_CGCM3_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Resilience",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MRI-CGCM3_RCP85")


#----BIODIVERSITY----#
diversity_MRI_CGCM3_RCP85_Resilience <- propBiomass_MRI_CGCM3_RCP85_Resilience[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_MRI_CGCM3_RCP85_Resilience <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}
AWB10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
AWB20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
AWB30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
AWB40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
AWB50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
AWB60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
AWB70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
AWB80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
AWBStack_MRI_CGCM3_RCP85_Resilience <- c(AWB10,AWB20,AWB30,AWB40,AWB50,AWB60,AWB70,AWB80)
plot(AWBStack_MRI_CGCM3_RCP85_Resilience)
AWBStack_CCSM4_RCP85_ResilienceDf <- AWBStack_MRI_CGCM3_RCP85_Resilience %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "AWB") %>%
  group_by(Time) %>%
  summarise(AWB = mean(AWB)) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")
```

### LSLV (CCSM4)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Resilience/RCP85/LSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_CCSM4_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Resilience")


# Proportional composition
propBiomass_CCSM4_RCP85_Resilience <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Resilience",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "CCSM4_RCP85")


#----BIODIVERSITY----#
diversity_CCSM4_RCP85_Resilience <- propBiomass_CCSM4_RCP85_Resilience[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_CCSM4_RCP85_Resilience <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")

#----ANNUAL WATER BUDGET----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}
AWB10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
AWB20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
AWB30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
AWB40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
AWB50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
AWB60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
AWB70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
AWB80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
AWBStack_CCSM4_RCP85_Resilience <- c(AWB10,AWB20,AWB30,AWB40,AWB50,AWB60,AWB70,AWB80)
plot(AWBStack_CCSM4_RCP85_Resilience)
AWBStack_CCSM4_RCP85_ResilienceDf <- AWBStack_CCSM4_RCP85_Resilience %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "AWB") %>%
  group_by(Time) %>%
  summarise(AWB = mean(AWB)) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Resilience")
```

# TRANSITION
## RCP45
### HSHV (BNU-ESM)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP45/HSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_BNU_ESM_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "BNU-ESM_RCP45",
         Prescription = "Transition")


# Proportional composition
propBiomass_BNU_ESM_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "BNU-ESM_RCP45",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
BNU_ESM_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "BNU-ESM_RCP45")


#----BIODIVERSITY----#
diversity_BNU_ESM_RCP45_Transition <- propBiomass_BNU_ESM_RCP45_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_BNU_ESM_RCP45_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")


ggplot(successionLog_BNU_ESM_RCP45_Transition, aes(x = Time, y = NEEC)) +
  geom_line() +
  theme_classic()


  

```

### HSLV (MIROC-ESM-CHEM)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP45/HSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_MIROC_ESM_CHEM_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "MIROC-ESM-CHEM_RCP45",
         Prescription = "Transition")


# Proportional composition
propBiomass_MIROC_ESM_CHEM_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "MIROC-ESM-CHEM_RCP45",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45")


#----BIODIVERSITY----#
diversity_MIROC_ESM_CHEM_RCP45_Transition <- propBiomass_MIROC_ESM_CHEM_RCP45_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_MIROC_ESM_CHEM_RCP45_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")


ggplot(successionLog_MIROC_ESM_CHEM_RCP45_Transition, aes(x = Time, y = NEEC)) +
  geom_line() +
  theme_classic()


  

```

### LSHV (MRI-CGCM3)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP45/LSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_MRI_CGCM3_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "MRI-CGCM3_RCP45",
         Prescription = "Transition")


# Proportional composition
propBiomass_MRI_CGCM3_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "MRI-CGCM3_RCP45",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MRI_CGCM3_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MRI-CGCM3_RCP45")


#----BIODIVERSITY----#
diversity_MRI_CGCM3_RCP45_Transition <- propBiomass_MRI_CGCM3_RCP45_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_MRI_CGCM3_RCP45_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")


ggplot(successionLog_MRI_CGCM3_RCP45_Transition, aes(x = Time, y = NEEC)) +
  geom_line() +
  theme_classic()


  

```

### LSLV (CCSM4)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP45/LSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_CCSM4_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP45",
         Model = "CCSM4_RCP45",
         Prescription = "Transition")


# Proportional composition
propBiomass_CCSM4_RCP45_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP45",
         Model = "CCSM4_RCP45",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
CCSM4_RCP45 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "CCSM4_RCP45")


#----BIODIVERSITY----#
diversity_CCSM4_RCP45_Transition <- propBiomass_CCSM4_RCP45_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_CCSM4_RCP45_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP45",
         RCP = "RCP45",
         Prescription = "Transition")


ggplot(successionLog_CCSM4_RCP45_Transition, aes(x = Time, y = NEEC)) +
  geom_line() +
  theme_classic()


  

```

## RCP85
### HSHV (BNU-ESM)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP85/HSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_BNU_ESM_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Transition")


# Proportional composition
propBiomass_BNU_ESM_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "BNU-ESM_RCP85",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
BNU_ESM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "BNU-ESM_RCP85")


#----BIODIVERSITY----#
diversity_BNU_ESM_RCP85_Transition <- propBiomass_BNU_ESM_RCP85_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_BNU_ESM_RCP85_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "BNU-ESM_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")


ggplot(successionLog_BNU_ESM_RCP85_Transition, aes(x = Time, y = NEEC)) +
  geom_line() +
  theme_classic()


  

```

### HSLV (MIROC-ESM-CHEM)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP85/HSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_MIROC_ESM_CHEM_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Transition")


# Proportional composition
propBiomass_MIROC_ESM_CHEM_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "MIROC-ESM-CHEM_RCP85",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MIROC_ESM_CHEM_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85")


#----BIODIVERSITY----#
diversity_MIROC_ESM_CHEM_RCP85_Transition <- propBiomass_MIROC_ESM_CHEM_RCP85_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_MIROC_ESM_CHEM_RCP85_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MIROC-ESM-CHEM_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")


ggplot(successionLog_MIROC_ESM_CHEM_RCP85_Transition, aes(x = Time, y = NEEC)) +
  geom_line() +
  theme_classic()


  

```

### LSHV (MRI-CGCM3)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP85/LSHV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_MRI_CGCM3_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Transition")


# Proportional composition
propBiomass_MRI_CGCM3_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "MRI-CGCM3_RCP85",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
MRI_CGCM3_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "MRI-CGCM3_RCP85")


#----BIODIVERSITY----#
diversity_MRI_CGCM3_RCP85_Transition <- propBiomass_MRI_CGCM3_RCP85_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_MRI_CGCM3_RCP85_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "MRI-CGCM3_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")


ggplot(successionLog_MRI_CGCM3_RCP85_Transition, aes(x = Time, y = NEEC)) +
  geom_line() +
  theme_classic()


  

```

### LSLV (CCSM4)

```{r}
#----Spp Biomass----#
mainDir <- "D:/Landis Outputs/Transition/RCP85/LSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)


# Composition through time
sppBiomass_CCSM4_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Transition")


# Proportional composition
propBiomass_CCSM4_RCP85_Transition <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)


#----Harvesting Rates----#
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))

#----Climate----#
# For loop to read in future climate data. Then organised into appropriate metrics
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)
CCSM4_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "CCSM4_RCP85")


#----BIODIVERSITY----#
diversity_CCSM4_RCP85_Transition <- propBiomass_CCSM4_RCP85_Transition[,c(1:3,9)] %>%
  mutate(Pi = Biomass_Percent / 100,
         lnPi = log(Pi),
         PixlnPi = Pi * lnPi) %>%
  group_by(Time) %>%
  summarise(H = -sum(PixlnPi, na.rm = TRUE)) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_CCSM4_RCP85_Transition <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")


ggplot(successionLog_CCSM4_RCP85_Transition, aes(x = Time, y = NEEC)) +
  geom_line() +
  theme_classic()


  

```



# Final Data
## Climate

```{r}
## Temperature
rbind(BNU_ESM_RCP45, MIROC_ESM_CHEM_RCP45, MRI_CGCM3_RCP45,CCSM4_RCP45,BNU_ESM_RCP85, MIROC_ESM_CHEM_RCP85, MRI_CGCM3_RCP85,CCSM4_RCP85) %>%
  ggplot(., aes(x = Year, y = airtemp, col = Model)) +
  geom_line() +
  theme_classic() +
  ylab("Mean Air Temp (°C)")

rbind(BNU_ESM_RCP45, MIROC_ESM_CHEM_RCP45, MRI_CGCM3_RCP45, CCSM4_RCP45, BNU_ESM_RCP85, MIROC_ESM_CHEM_RCP85, MRI_CGCM3_RCP85, CCSM4_RCP85) %>%
  mutate(RCP = ifelse(grepl("45", Model), "RCP45", "RCP85")) %>%
  ggplot(., aes(x = Year, y = airtemp, col = Model)) +
  geom_line() +
  theme_classic() +
  ylab("Mean Air Temp (°C)") +
  facet_wrap(~RCP)

## Precipitation
rbind(BNU_ESM_RCP45, MIROC_ESM_CHEM_RCP45, MRI_CGCM3_RCP45,CCSM4_RCP45,BNU_ESM_RCP85, MIROC_ESM_CHEM_RCP85, MRI_CGCM3_RCP85,CCSM4_RCP85) %>%
  ggplot(., aes(x = Year, y = sumppt, col = Model)) +
  geom_line() +
  theme_classic() +
  ylab("Total Precipitation (mm)")

rbind(BNU_ESM_RCP45, MIROC_ESM_CHEM_RCP45, MRI_CGCM3_RCP45, CCSM4_RCP45, BNU_ESM_RCP85, MIROC_ESM_CHEM_RCP85, MRI_CGCM3_RCP85, CCSM4_RCP85) %>%
  mutate(RCP = ifelse(grepl("45", Model), "RCP45", "RCP85")) %>%
  ggplot(., aes(x = Year, y = sumppt, col = Model)) +
  geom_line() +
  theme_classic() +
  ylab("Total Precipitation (mm)") +
  facet_wrap(~RCP)
```

## Harvesting

```{r}
#----HARVESTING----#
#----TRANSITION----#
# Residual Biomass by Species, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP45,sppBiomass_BNU_ESM_RCP85,sppBiomass_CCSM4_RCP45,sppBiomass_CCSM4_RCP85,sppBiomass_MIROC_ESM_CHEM_RCP45,sppBiomass_MIROC_ESM_CHEM_RCP85,sppBiomass_MRI_CGCM3_RCP45,sppBiomass_MRI_CGCM3_RCP85) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (MG)", breaks = seq(0,12000,2000), labels = seq(0,12,2))


# Residual Biomass by Functional Group, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP45,sppBiomass_BNU_ESM_RCP85,sppBiomass_CCSM4_RCP45,sppBiomass_CCSM4_RCP85,sppBiomass_MIROC_ESM_CHEM_RCP45,sppBiomass_MIROC_ESM_CHEM_RCP85,sppBiomass_MRI_CGCM3_RCP45,sppBiomass_MRI_CGCM3_RCP85) %>%
  filter(Time < 81) %>%
  mutate(FunctionalGroup = ifelse(Species %in% softwoods, "Softwood",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods"))) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (MG)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# Proportional Biomass by Species, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP45,propBiomass_BNU_ESM_RCP85,propBiomass_CCSM4_RCP45,propBiomass_CCSM4_RCP85,propBiomass_MIROC_ESM_CHEM_RCP45,propBiomass_MIROC_ESM_CHEM_RCP85,propBiomass_MRI_CGCM3_RCP45,propBiomass_MRI_CGCM3_RCP85) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)

# Proportional Biomass by Functional Group, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP45,propBiomass_BNU_ESM_RCP85,propBiomass_CCSM4_RCP45,propBiomass_CCSM4_RCP85,propBiomass_MIROC_ESM_CHEM_RCP45,propBiomass_MIROC_ESM_CHEM_RCP85,propBiomass_MRI_CGCM3_RCP45,propBiomass_MRI_CGCM3_RCP85) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)
```

## Biomass

```{r}
#----RESISTANCE----#
# Residual Biomass by Species, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP45_Resistance,sppBiomass_BNU_ESM_RCP85_Resistance,sppBiomass_CCSM4_RCP45_Resistance,sppBiomass_CCSM4_RCP85_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP45_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP85_Resistance,sppBiomass_MRI_CGCM3_RCP45_Resistance,sppBiomass_MRI_CGCM3_RCP85_Resistance) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (MG)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# Residual Biomass by Functional Group, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP45_Resistance,sppBiomass_BNU_ESM_RCP85_Resistance,sppBiomass_CCSM4_RCP45_Resistance,sppBiomass_CCSM4_RCP85_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP45_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP85_Resistance,sppBiomass_MRI_CGCM3_RCP45_Resistance,sppBiomass_MRI_CGCM3_RCP85_Resistance) %>%
  filter(Time < 81) %>%
  mutate(FunctionalGroup = ifelse(Species %in% softwoods, "Softwood",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods"))) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (MG)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# Proportional Biomass by Species, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP45_Resistance,propBiomass_BNU_ESM_RCP85_Resistance,propBiomass_CCSM4_RCP45_Resistance,propBiomass_CCSM4_RCP85_Resistance,propBiomass_MIROC_ESM_CHEM_RCP45_Resistance,propBiomass_MIROC_ESM_CHEM_RCP85_Resistance,propBiomass_MRI_CGCM3_RCP45_Resistance,propBiomass_MRI_CGCM3_RCP85_Resistance) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)

# Proportional Biomass by Functional Group, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP45_Resistance,propBiomass_BNU_ESM_RCP85_Resistance,propBiomass_CCSM4_RCP45_Resistance,propBiomass_CCSM4_RCP85_Resistance,propBiomass_MIROC_ESM_CHEM_RCP45_Resistance,propBiomass_MIROC_ESM_CHEM_RCP85_Resistance,propBiomass_MRI_CGCM3_RCP45_Resistance,propBiomass_MRI_CGCM3_RCP85_Resistance) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)

#----RESILIENCE----#
# Residual Biomass by Species, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP85_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience,sppBiomass_MRI_CGCM3_RCP85_Resilience,sppBiomass_CCSM4_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (MG)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# Residual Biomass by Functional Group, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP85_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience,sppBiomass_MRI_CGCM3_RCP85_Resilience,sppBiomass_CCSM4_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  mutate(FunctionalGroup = ifelse(Species %in% softwoods, "Softwood",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods"))) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (MG)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# Proportional Biomass by Species, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP85_Resilience,propBiomass_MIROC_ESM_CHEM_RCP85_Resilience,propBiomass_MRI_CGCM3_RCP85_Resilience,propBiomass_CCSM4_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)

# Proportional Biomass by Functional Group, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP85_Resilience,propBiomass_MIROC_ESM_CHEM_RCP85_Resilience,propBiomass_MRI_CGCM3_RCP85_Resilience,propBiomass_CCSM4_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)

```




## Succession Log Variables

```{r}
#----SUCCESSION LOG----#
successionLog <- rbind(successionLog_BNU_ESM_RCP45_Resistance,successionLog_BNU_ESM_RCP45_Transition,successionLog_BNU_ESM_RCP85_Resilience,successionLog_BNU_ESM_RCP85_Resistance,successionLog_BNU_ESM_RCP85_Transition,successionLog_MIROC_ESM_CHEM_RCP45_Resistance,successionLog_MIROC_ESM_CHEM_RCP45_Transition,successionLog_MIROC_ESM_CHEM_RCP85_Transition,successionLog_MIROC_ESM_CHEM_RCP85_Resilience,successionLog_MIROC_ESM_CHEM_RCP85_Resistance,successionLog_MIROC_ESM_CHEM_RCP45_Transition,successionLog_MRI_CGCM3_RCP45_Resistance,successionLog_MRI_CGCM3_RCP45_Transition,successionLog_MRI_CGCM3_RCP85_Resistance,successionLog_MRI_CGCM3_RCP85_Transition,successionLog_CCSM4_RCP45_Resistance,successionLog_CCSM4_RCP45_Transition,successionLog_CCSM4_RCP85_Resistance,successionLog_CCSM4_RCP85_Transition,successionLog_MRI_CGCM3_RCP85_Resilience,successionLog_CCSM4_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  select(-ClimateRegionIndex, -NumSites)

# NEEC
successionLog %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = NEEC, col = Model)) +
  geom_line(alpha = 0) +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(RCP ~ Prescription) +
  scale_x_continuous(name = "Year", breaks = c(0,20,40,60,80), labels = c(2020,2040,2060,2080,2100)) +
  geom_smooth(se = FALSE)

# SOMTC
successionLog %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = SOMTC, col = Model)) +
  geom_line(alpha = 0) +
  theme_classic() +
  ylim(2400,4000) +
  geom_hline(yintercept = 3000, linetype = "dashed") +
  facet_wrap(RCP ~ Prescription) +
  scale_x_continuous(name = "Year", breaks = c(0,20,40,60,80), labels = c(2020,2040,2060,2080,2100)) +
  geom_smooth(se = FALSE)

# NPP
successionLog %>%
  mutate(Model = sub("_[^_]+$", "", Model),
         NPP = (AG_NPPC + BG_NPPC) * 2) %>%
  ggplot(., aes(x = Time, y = NPP, col = Model)) +
  geom_line(alpha = 0) +
  theme_classic() +
  facet_wrap(RCP ~ Prescription) +
  scale_x_continuous(name = "Year", breaks = c(0,20,40,60,80), labels = c(2020,2040,2060,2080,2100)) +
  ylab("Total Net Primary Productivity") +
  geom_smooth(se = FALSE)

# TotalN
successionLog %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = TotalN, col = Model)) +
  geom_line(alpha = 0) +
  theme_classic() +
  facet_wrap(RCP ~ Prescription) +
  scale_x_continuous(name = "Year", breaks = c(0,20,40,60,80), labels = c(2020,2040,2060,2080,2100)) +
  ylab("Total N") +
  geom_smooth(se = FALSE)

# Age Mortality
successionLog %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = AgeMortality, col = Model)) +
  geom_line(alpha = 0) +
  theme_classic() +
  facet_wrap(RCP ~ Prescription) +
  scale_x_continuous(name = "Year", breaks = c(0,20,40,60,80), labels = c(2020,2040,2060,2080,2100)) +
  ylab("Senesced Biomass (g/m2)") +
  geom_smooth(se = FALSE)

# Litterfall
successionLog %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Litterfall, col = Model)) +
  geom_line(alpha = 0) +
  theme_classic() +
  facet_wrap(RCP ~ Prescription) +
  scale_x_continuous(name = "Year", breaks = c(0,20,40,60,80), labels = c(2020,2040,2060,2080,2100)) +
  ylab("Litterfall (g/m2)") +
  geom_smooth(se = FALSE)

```


#----RESILIENCE----#
# Residual Biomass by Species, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP85_Resilience, sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (MG)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# Residual Biomass by Functional Group, Climate Model and RCP
rbind(sppBiomass_BNU_ESM_RCP85_Resilience, sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  mutate(FunctionalGroup = ifelse(Species %in% softwoods, "Softwood",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods"))) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE) +
  scale_x_continuous(name = "Year", breaks = seq(0,80,10), labels = seq(2020,2100,10)) +
  scale_y_continuous(name = "Biomass (MG)", breaks = seq(0,12000,2000), labels = seq(0,12,2))

# Proportional Biomass by Species, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP85_Resilience, propBiomass_MIROC_ESM_CHEM_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)

# Proportional Biomass by Functional Group, Climate Model and RCP
rbind(propBiomass_BNU_ESM_RCP85_Resilience, propBiomass_MIROC_ESM_CHEM_RCP85_Resilience) %>%
  filter(Time < 81) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(RCP ~ Model, drop = TRUE)

#----ALL HARVESTING----#
#----MODEL & PRESCRIPTION TYPE----#
#----RCP85----#
# Residual biomass by species, model type and prescription type
rbind(sppBiomass_BNU_ESM_RCP45_Resistance,sppBiomass_BNU_ESM_RCP85_Resistance,sppBiomass_CCSM4_RCP45_Resistance,sppBiomass_CCSM4_RCP85_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP45_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP85_Resistance,sppBiomass_MRI_CGCM3_RCP45_Resistance,sppBiomass_MRI_CGCM3_RCP85_Resistance,sppBiomass_BNU_ESM_RCP45,sppBiomass_BNU_ESM_RCP85,sppBiomass_CCSM4_RCP45,sppBiomass_CCSM4_RCP85,sppBiomass_MIROC_ESM_CHEM_RCP45,sppBiomass_MIROC_ESM_CHEM_RCP85,sppBiomass_MRI_CGCM3_RCP45,sppBiomass_MRI_CGCM3_RCP85,sppBiomass_BNU_ESM_RCP85_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience) %>%
  filter(RCP == "RCP85",
         Time < 81) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, col = Species, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(Prescription ~ Model) +
  scale_y_continuous(name = "kg/m2",
                     breaks = c(0,2e3,4e3,6e3,8e3,1e4,1.2e4),
                     labels = c(0,2,4,6,8,10,12)) +
  scale_x_continuous(name = "Year",
                     breaks = c(0,20,40,60,80),
                     labels = c(2020,2040,2060,2080,2100))

# Proportional residual biomass by species, model type and prescription type
rbind(propBiomass_BNU_ESM_RCP45_Resistance,propBiomass_BNU_ESM_RCP85_Resistance,propBiomass_CCSM4_RCP45_Resistance,propBiomass_CCSM4_RCP85_Resistance,propBiomass_MIROC_ESM_CHEM_RCP45_Resistance,propBiomass_MIROC_ESM_CHEM_RCP85_Resistance,propBiomass_MRI_CGCM3_RCP45_Resistance,propBiomass_MRI_CGCM3_RCP85_Resistance,propBiomass_BNU_ESM_RCP45,propBiomass_BNU_ESM_RCP85,propBiomass_CCSM4_RCP45,propBiomass_CCSM4_RCP85,propBiomass_MIROC_ESM_CHEM_RCP45,propBiomass_MIROC_ESM_CHEM_RCP85,propBiomass_MRI_CGCM3_RCP45,propBiomass_MRI_CGCM3_RCP85,propBiomass_BNU_ESM_RCP85_Resilience,propBiomass_MIROC_ESM_CHEM_RCP85_Resilience) %>%
  filter(RCP == "RCP85",
         Time < 81) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, col = Species, fill = Species)) +
  geom_bar(stat = "identity", col = "black") +
  theme_classic() +
  facet_grid(Prescription ~ Model) +
  ylab("Percent Biomass") +
  scale_x_continuous(name = "Year",
                     breaks = c(0,20,40,60,80),
                     labels = c(2020,2040,2060,2080,2100))

# Residual biomass by functional group, model type and prescription type
rbind(sppBiomass_BNU_ESM_RCP45_Resistance,sppBiomass_BNU_ESM_RCP85_Resistance,sppBiomass_CCSM4_RCP45_Resistance,sppBiomass_CCSM4_RCP85_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP45_Resistance,sppBiomass_MIROC_ESM_CHEM_RCP85_Resistance,sppBiomass_MRI_CGCM3_RCP45_Resistance,sppBiomass_MRI_CGCM3_RCP85_Resistance,sppBiomass_BNU_ESM_RCP45,sppBiomass_BNU_ESM_RCP85,sppBiomass_CCSM4_RCP45,sppBiomass_CCSM4_RCP85,sppBiomass_MIROC_ESM_CHEM_RCP45,sppBiomass_MIROC_ESM_CHEM_RCP85,sppBiomass_MRI_CGCM3_RCP45,sppBiomass_MRI_CGCM3_RCP85,sppBiomass_BNU_ESM_RCP85_Resilience,sppBiomass_MIROC_ESM_CHEM_RCP85_Resilience) %>%
  filter(RCP == "RCP85",
         Time < 81) %>%
  mutate(FunctionalGroup = ifelse(Species %in% softwoods, "Softwood",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods"))) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_MG, col = FunctionalGroup, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ Model) +
  scale_y_continuous(name = "kg/m2",
                     breaks = c(0,2e3,4e3,6e3,8e3,1e4,1.2e4),
                     labels = c(0,2,4,6,8,10,12)) +
  scale_x_continuous(name = "Year",
                     breaks = c(0,20,40,60,80),
                     labels = c(2020,2040,2060,2080,2100))


# Proportional residual biomass by functional group, model type and prescription type
rbind(propBiomass_BNU_ESM_RCP45_Resistance,propBiomass_BNU_ESM_RCP85_Resistance,propBiomass_CCSM4_RCP45_Resistance,propBiomass_CCSM4_RCP85_Resistance,propBiomass_MIROC_ESM_CHEM_RCP45_Resistance,propBiomass_MIROC_ESM_CHEM_RCP85_Resistance,propBiomass_MRI_CGCM3_RCP45_Resistance,propBiomass_MRI_CGCM3_RCP85_Resistance,propBiomass_BNU_ESM_RCP45,propBiomass_BNU_ESM_RCP85,propBiomass_CCSM4_RCP45,propBiomass_CCSM4_RCP85,propBiomass_MIROC_ESM_CHEM_RCP45,propBiomass_MIROC_ESM_CHEM_RCP85,propBiomass_MRI_CGCM3_RCP45,propBiomass_MRI_CGCM3_RCP85,propBiomass_BNU_ESM_RCP85_Resilience,propBiomass_MIROC_ESM_CHEM_RCP85_Resilience) %>%
  filter(RCP == "RCP85",
         Time < 81) %>%
  mutate(FunctionalGroup = ifelse(Species %in% softwoods, "Softwood",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods"))) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  ggplot(., aes(x = Time, y = Biomass_Percent, col = FunctionalGroup, fill = FunctionalGroup)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ Model) +
  ylab("Percent Biomass") +
  scale_x_continuous(name = "Year",
                     breaks = c(0,20,40,60,80),
                     labels = c(2020,2040,2060,2080,2100))
  


 
#----DIVERSITY----#
rbind(diversity_BNU_ESM_RCP45_Resistance,diversity_BNU_ESM_RCP45_Transition,diversity_BNU_ESM_RCP85_Resilience,diversity_BNU_ESM_RCP85_Resistance,diversity_BNU_ESM_RCP85_Transition,diversity_CCSM4_RCP45_Resistance,diversity_CCSM4_RCP45_Transition,diversity_CCSM4_RCP85_Resistance,diversity_CCSM4_RCP85_Transition,diversity_MIROC_ESM_CHEM_RCP45_Resistance,diversity_MIROC_ESM_CHEM_RCP45_Transition,diversity_MIROC_ESM_CHEM_RCP85_Resilience,diversity_MIROC_ESM_CHEM_RCP85_Resistance,diversity_MIROC_ESM_CHEM_RCP85_Transition,diversity_MRI_CGCM3_RCP45_Resistance,diversity_MRI_CGCM3_RCP45_Transition,diversity_MRI_CGCM3_RCP85_Resistance,diversity_MRI_CGCM3_RCP85_Transition) %>%
  mutate(Model = sub("_[^_]+$", "", Model)) %>%
  filter(Time < 81) %>%
  ggplot(., aes(x = Time, y = H, col = Model)) +
  geom_line(size = 2) +
  theme_classic() +
  facet_grid(RCP ~ Prescription)


```






# OLD RASTER FORMAT
### LSLV (CCSM4)

```{r}
# Spp Biomass
mainDir <- "D:/Landis Outputs/Transition/RCP85/LSLV"
runs <- paste0("run", 1:5)
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "spp-biomass-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData) %>%
  select(-`...34`)

# Composition through time
sppBiomass_CCSM4_RCP85 <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Transition")

# Proportional composition
propBiomass_CCSM4_RCP85 <- finalTable %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  mutate(RCP = "RCP85",
         Model = "CCSM4_RCP85",
         Prescription = "Transition",
         FunctionalGroup = ifelse(Species %in% softwoods, "Softwoods",
                                  ifelse(Species %in% oaks, "Oaks", "Hardwoods")),
         TotalBiomass = sum(Biomass_MG),
         Biomass_Percent = (Biomass_MG / TotalBiomass) * 100)

# Harvesting Rates
## Normal
combinedData <- list()
for (run in runs){
  harvestDir <- file.path(mainDir, run, "Harvest")
  filePath <- file.path(harvestDir, "biomass-harvest-summary-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}
finalTable <- do.call(rbind, combinedData)

finalTable[,c(1,2,3,38:67,69)] %>%
  pivot_longer(cols = c("BiomassHarvestedMg_ACRU":"BiomassHarvestedMg_TADI2"), names_to = "Species", values_to = "Harvested_Biomass") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", ""),
         Prescription = str_replace(Prescription, "\\s*\\([^)]*\\)", "")) %>%
  group_by(Time, Prescription, ManagementArea, Species) %>%
  summarise(mean = mean(Harvested_Biomass),
            sd = sd(Harvested_Biomass)) %>%
  ggplot(., aes(x = Time, y = mean, col = Species, fill = Species)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_grid(Prescription ~ ManagementArea) +
  scale_y_continuous(name = "Biomass in Millions of Mg",
                     breaks = c(0,1e6,2e6,3e6,4e6),
                     labels = c(0,1,2,3,4))


# Climate
climateData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "Climate-future-input-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  climateData[[run]] <- data
}
climateData <- do.call(rbind, climateData) %>%
  select(-`...28`)


CCSM4_RCP85 <- climateData[,c(1,2,5,6,7,28)] %>%
  mutate(mean_airtemp = (min_airtemp + max_airtemp) / 2) %>%
  group_by(Year) %>%
  summarise(meanppt = mean(ppt),
            sumppt = sum(ppt),
            airtemp = mean(mean_airtemp)) %>%
  mutate(Model = "CCSM4_RCP85")

# Annual Water Budget
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("Annual-water-budget-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)                                        # Flip added because it was coming out upside down
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)  # Convert to .tif file
    combinedRasters[[newFileName]] <- rasterData
    print(paste("Successfully read:", newFileName))
  }
}

AWB10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
AWB20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
AWB30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
AWB40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
AWB50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
AWB60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
AWB70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
AWB80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
AWBStack_CCSM4_RCP85 <- c(AWB10,AWB20,AWB30,AWB40,AWB50,AWB60,AWB70,AWB80)
plot(AWBStack_CCSM4_RCP85)


AWBStack_CCSM4_RCP85Df <- AWBStack_CCSM4_RCP85 %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "AWB") %>%
  group_by(Time) %>%
  summarise(AWB = mean(AWB)) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")



#----SOMTC----#
combinedRasters <- list()
for (run in 1:5) {
  runDir <- file.path(mainDir, paste0("run", run))
  for (year in seq(10, 80, by = 10)) {
    filename <- paste0("SOMTC-", year, ".img")
    filePath <- file.path(runDir, filename)
    rasterData <- rast(filePath)
    crs(rasterData) <- "epsg:26917"
    rasterData <- flip(rasterData)
    newFileName <- sub("\\.img$", paste0("_run", run, ".tif"), filename)
    combinedRasters[[newFileName]] <- rasterData
  }
}
SOMTC10 <- c(combinedRasters[[1]],combinedRasters[[9]],combinedRasters[[17]],combinedRasters[[25]],combinedRasters[[33]]) %>% app(., "mean")
SOMTC20 <- c(combinedRasters[[2]],combinedRasters[[10]],combinedRasters[[18]],combinedRasters[[26]],combinedRasters[[34]]) %>% app(., "mean")
SOMTC30 <- c(combinedRasters[[3]],combinedRasters[[11]],combinedRasters[[19]],combinedRasters[[27]],combinedRasters[[35]]) %>% app(., "mean")
SOMTC40 <- c(combinedRasters[[4]],combinedRasters[[12]],combinedRasters[[20]],combinedRasters[[28]],combinedRasters[[36]]) %>% app(., "mean")
SOMTC50 <- c(combinedRasters[[5]],combinedRasters[[13]],combinedRasters[[21]],combinedRasters[[29]],combinedRasters[[37]]) %>% app(., "mean")
SOMTC60 <- c(combinedRasters[[6]],combinedRasters[[14]],combinedRasters[[22]],combinedRasters[[30]],combinedRasters[[38]]) %>% app(., "mean")
SOMTC70 <- c(combinedRasters[[7]],combinedRasters[[15]],combinedRasters[[23]],combinedRasters[[31]],combinedRasters[[39]]) %>% app(., "mean")
SOMTC80 <- c(combinedRasters[[8]],combinedRasters[[16]],combinedRasters[[24]],combinedRasters[[32]],combinedRasters[[40]]) %>% app(., "mean")
SOMTCStack_CCSM4_RCP85 <- c(SOMTC10,SOMTC20,SOMTC30,SOMTC40,SOMTC50,SOMTC60,SOMTC70,SOMTC80)
plot(SOMTCStack_CCSM4_RCP85)
SOMTCStack_CCSM4_RCP85Df <- SOMTCStack_CCSM4_RCP85 %>%
  as.data.frame() %>%
  `colnames<-`(c(2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) %>%
  mutate(rowSums = rowSums(.)) %>%
  filter(rowSums > 0) %>%
  select(-rowSums) %>%
  pivot_longer(cols = c(`2030`, `2040`, `2050`, `2060`, `2070`, `2080`, `2090`, `2100`), 
               names_to = "Time", 
               values_to = "SOMTC") %>%
  group_by(Time) %>%
  summarise(SOMTC = mean(SOMTC)) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")


#----SUCCESSION LOG VARIABLES----#
combinedData <- list()
for (run in runs){
  runDir <- file.path(mainDir, run)
  filePath <- file.path(runDir, "NECN-succession-log.csv")
  data <- read_csv(filePath)
  data$Run <- run
  combinedData[[run]] <- data
}

successionLog_CCSM4_RCP85 <- rbind(combinedData[[1]], combinedData[[2]], combinedData[[3]], combinedData[[4]], combinedData[[5]]) %>%
  select(-`...62`) %>%
  group_by(Time) %>%
  summarise(across(where(is.numeric), ~ weighted.mean(x = ., w = rep(c(528897, 24948), length.out = n())))) %>%
  mutate(Model = "CCSM4_RCP85",
         RCP = "RCP85",
         Prescription = "Transition")
```










```{r}
sppBiomass_BNU_ESM_RCP45_Resistance %>%
  group_by(Time) %>%
  summarise(sum = sum(Biomass_MG))

read_csv("C:/Users/lagoodal/Desktop/Dissertation Stuff/Chapter 2/LANDIS Outputs/TREE MAP/NEW/TRANSITION/Test 8/spp-biomass-log.csv")
resistanceBiomass %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites, -`...34`) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time) %>%
  summarise(sum = sum(Biomass_MG))


read_csv("C:/Users/lagoodal/Desktop/Dissertation Stuff/Chapter 2/LANDIS Outputs/TREE MAP/NEW/TRANSITION/Test 8/spp-biomass-log.csv") %>%
  filter(NumActiveSites != 0) %>%
  select(-EcoName, -NumActiveSites, -`...34`) %>%
  pivot_longer(cols = c("AboveGroundBiomass_ACRU":"AboveGroundBiomass_TADI2"), names_to = "Species", values_to = "Biomass_MG") %>%
  mutate(Species = str_replace(Species, "^[^_]*_", "")) %>%
  group_by(Time, Species) %>%
  summarise(Biomass_MG = weighted.mean(x = Biomass_MG, w = rep(c(528897,24948), length.out = n()))) %>%
  group_by(Time) %>%
  summarise(sum = sum(Biomass_MG))


23448.54 / 11538.15


read_csv("D:/Landis Outputs/Transition/RCP85/LSHV/NECN-succession-log-short.csv")


x <- rast("C:/Users/lagoodal/Documents/TEST HPC OUTPUTS/landis/Clipped_Piedmont/finalTreeMap.tif")

activeCat(x) <- 5

x %>%
  as.data.frame()
``` 






















  
  









































